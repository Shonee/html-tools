<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="icon" content="ğŸ”–">
  <meta name="category" content="JSON">
  <meta name="keywords" content="JSON æ ¼å¼åŒ–å·¥å…·">
  <meta name="description" content="JSON æ ¼å¼åŒ–ã€å‹ç¼©ã€è½¬ä¹‰å·¥å…·">
  <meta name="features" content="JSONæ ¼å¼åŒ–ã€JSONè½¬ä¹‰ã€JSONå‹ç¼©">
  <meta name="rank" content="997"/>
  <meta name="show" content="true"/>
  <title>JSON æ ¼å¼åŒ–å·¥å…·</title>
  
  <!-- Font Awesome å›¾æ ‡åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- CodeMirror æ ¸å¿ƒä¸ JSON æ¨¡å¼ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material-darker.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
  
  <!-- highlight.js è¯­æ³•é«˜äº®ä¸è¡Œå·æ’ä»¶ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
  
  <style>
    :root {
      --primary-color: #4a6cf7;
      --primary-hover: #3a5bd9;
      --secondary-color: #f5f5f5;
      --text-color: #333;
      --light-text: #666;
      --error-color: #e53935;
      --success-color: #43a047;
      --border-color: #ddd;
      --bg-color: #fff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #f9fafb;
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 2.2rem;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--light-text);
      font-size: 1rem;
    }

    .json-formatter {
      background-color: var(--bg-color);
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .options {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .option-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    label {
      font-weight: 500;
      color: var(--light-text);
      font-size: 0.9rem;
    }

    input[type="number"] {
      width: 60px;
      padding: 0.4rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.9rem;
    }

    input[type="checkbox"] {
      cursor: pointer;
    }

    .btn {
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: var(--text-color);
    }

    .btn-secondary:hover {
      background-color: #e8e8e8;
    }

    .editor-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.5rem;
      min-height: 500px;
    }

    @media (max-width: 768px) {
      .editor-container {
        grid-template-columns: 1fr;
      }
      
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .actions, .options {
        width: 100%;
      }
    }

    .editor-panel {
      display: flex;
      flex-direction: column;
      min-width: 0;
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .panel-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-color);
    }

    .panel-actions {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .panel-stats {
      font-size: 0.85rem;
      color: var(--light-text);
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--light-text);
      font-size: 1rem;
      padding: 0.3rem;
      border-radius: 3px;
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      color: var(--primary-color);
      background-color: rgba(74, 108, 247, 0.1);
    }

    .editor {
      height: 500px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .CodeMirror {
      height: 100% !important;
      width: 100% !important;
      max-width: 100% !important;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      box-sizing: border-box !important;
    }

    .CodeMirror-scroll {
      overflow-y: auto !important;
      overflow-x: auto !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }

    .CodeMirror-lines {
      padding: 4px 0;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }

    .CodeMirror pre {
      padding: 0 4px;
      line-height: 1.5;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      max-width: 100% !important;
      box-sizing: border-box !important;
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }

    .CodeMirror-line {
      max-width: 100% !important;
      box-sizing: border-box !important;
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
    }

    .output-viewer {
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: #282c34;
      color: #abb2bf;
      padding: 0;
      position: relative;
    }

    .output-viewer pre {
      margin: 0;
      padding: 1rem;
      white-space: pre;
      min-height: calc(100% - 2rem);
    }

    /* å‹ç¼©æ¨¡å¼æ ·å¼ */
    .output-viewer.minified pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    /* æ ‘çŠ¶è§†å›¾æ ·å¼ */
    .output-viewer.tree-view {
      background-color: #282c34;
      padding: 1rem;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
    }

    .tree-node {
      position: relative;
      margin: 2px 0;
    }

    .tree-node-content {
      display: flex;
      align-items: center;
      padding: 2px 0;
      border-radius: 3px;
      transition: background-color 0.15s;
    }

    .tree-node-content:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .tree-toggle {
      display: inline-block;
      width: 16px;
      height: 16px;
      cursor: pointer;
      user-select: none;
      margin-right: 4px;
      text-align: center;
      line-height: 16px;
      color: #888;
      flex-shrink: 0;
    }

    .tree-toggle:hover {
      color: #4a6cf7;
    }

    .tree-toggle.collapsed::before {
      content: 'â–¶';
    }

    .tree-toggle.expanded::before {
      content: 'â–¼';
    }

    .tree-toggle.no-toggle {
      visibility: hidden;
    }

    .tree-key {
      color: #e06c75;
      margin-right: 4px;
    }

    .tree-colon {
      color: #abb2bf;
      margin-right: 4px;
    }

    .tree-value {
      color: #98c379;
    }

    .tree-value.string {
      color: #98c379;
    }

    .tree-value.number {
      color: #d19a66;
    }

    .tree-value.boolean {
      color: #56b6c2;
    }

    .tree-value.null {
      color: #888;
    }

    .tree-bracket {
      color: #abb2bf;
    }

    .tree-children {
      margin-left: 20px;
    }

    .tree-children.collapsed {
      display: none;
    }

    .tree-copy-btn {
      display: none;
      margin-left: 8px;
      padding: 2px 6px;
      background-color: rgba(74, 108, 247, 0.2);
      border: none;
      border-radius: 3px;
      color: #4a6cf7;
      cursor: pointer;
      font-size: 0.75rem;
      transition: all 0.15s;
    }

    .tree-copy-btn:hover {
      background-color: rgba(74, 108, 247, 0.3);
      color: #6a8cf7;
    }

    .tree-node-content:hover .tree-copy-btn {
      display: inline-block;
    }

    .tree-ellipsis {
      color: #888;
      font-style: italic;
    }

    .output-viewer code {
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* highlight.js è¡Œå·æ ·å¼ */
    .hljs-ln-numbers {
      user-select: none;
      text-align: right;
      color: #5c6370;
      border-right: 1px solid #3e4451;
      padding-right: 0.8rem !important;
      vertical-align: top;
    }

    .hljs-ln-code {
      padding-left: 1rem !important;
    }

    .status-bar {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 4px;
      font-size: 0.9rem;
      display: none;
      white-space: pre-wrap;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      line-height: 1.6;
    }

    .status-bar.error {
      background-color: rgba(229, 57, 53, 0.1);
      color: var(--error-color);
      display: block;
      border-left: 4px solid var(--error-color);
    }

    .status-bar.success {
      background-color: rgba(67, 160, 71, 0.1);
      color: var(--success-color);
      display: block;
      border-left: 4px solid var(--success-color);
    }

    footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
      color: var(--light-text);
      font-size: 0.9rem;
    }

    /* æš—è‰²æ¨¡å¼æ”¯æŒ */
    @media (prefers-color-scheme: dark) {
      :root {
        --text-color: #e0e0e0;
        --light-text: #aaa;
        --border-color: #444;
        --bg-color: #1e293b;
        --secondary-color: #334155;
      }

      body {
        background-color: #0f172a;
      }

      .btn-secondary {
        background-color: #334155;
        color: #e0e0e0;
      }

      .btn-secondary:hover {
        background-color: #475569;
      }

      .CodeMirror {
        background-color: #1e293b;
        color: #e0e0e0;
      }

      .output-viewer {
        background-color: #1b2433;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>JSON æ ¼å¼åŒ–å·¥å…·</h1>
      <p class="subtitle">è½»æ¾æ ¼å¼åŒ–ã€éªŒè¯ã€å‹ç¼©å’Œè½¬ä¹‰ä½ çš„ JSON æ•°æ®</p>
    </header>

    <div class="json-formatter">
      <div class="toolbar">
        <div class="actions">
          <button id="format-btn" class="btn btn-primary">
            <i class="fas fa-magic"></i> æ ¼å¼åŒ–
          </button>
          <button id="minify-btn" class="btn btn-secondary">
            <i class="fas fa-compress-alt"></i> å‹ç¼©
          </button>
          <button id="escape-btn" class="btn btn-secondary">
            <i class="fas fa-quote-right"></i> è½¬ä¹‰
          </button>
          <button id="clear-btn" class="btn btn-secondary">
            <i class="fas fa-trash"></i> æ¸…ç©º
          </button>
          <button id="example-btn" class="btn btn-secondary">
            <i class="fas fa-lightbulb"></i> ç¤ºä¾‹
          </button>
        </div>
        <div class="options">
          <div class="option-group">
            <label for="indent-size">ç¼©è¿›ç©ºæ ¼:</label>
            <input type="number" id="indent-size" min="1" max="8" value="2">
          </div>
          <div class="option-group">
            <label for="view-mode">è¾“å‡ºæ¨¡å¼:</label>
            <select id="view-mode" style="padding: 0.4rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.9rem;">
              <option value="tree">æ ‘çŠ¶è§†å›¾</option>
              <option value="text">çº¯æ–‡æœ¬</option>
            </select>
          </div>
        </div>
      </div>

      <div class="editor-container">
        <div class="editor-panel">
          <div class="panel-header">
            <span class="panel-title">è¾“å…¥ JSON</span>
            <div class="panel-actions">
              <button id="copy-input-btn" class="icon-btn" title="å¤åˆ¶è¾“å…¥å†…å®¹">
                <i class="fas fa-copy"></i>
              </button>
              <span id="input-stats" class="panel-stats">0 å­—ç¬¦</span>
            </div>
          </div>
          <div class="editor">
            <textarea id="input-editor" placeholder="åœ¨è¿™é‡Œç²˜è´´ä½ çš„ JSON æ•°æ®..."></textarea>
          </div>
        </div>

        <div class="editor-panel">
          <div class="panel-header">
            <span class="panel-title">æ ¼å¼åŒ–ç»“æœ</span>
            <div class="panel-actions">
              <button id="collapse-all-btn" class="icon-btn" title="å…¨éƒ¨æŠ˜å " style="display: none;">
                <i class="fas fa-compress"></i>
              </button>
              <button id="expand-all-btn" class="icon-btn" title="å…¨éƒ¨å±•å¼€" style="display: none;">
                <i class="fas fa-expand"></i>
              </button>
              <button id="copy-output-btn" class="icon-btn" title="å¤åˆ¶è¾“å‡ºå†…å®¹">
                <i class="fas fa-copy"></i>
              </button>
              <span id="output-stats" class="panel-stats">0 å­—ç¬¦</span>
            </div>
          </div>
          <div class="editor">
            <div id="output-viewer" class="output-viewer"></div>
          </div>
        </div>
      </div>

      <div id="status-bar" class="status-bar"></div>
    </div>

    <footer>
      <p>&copy; <span id="current-year"></span> JSON æ ¼å¼åŒ–å·¥å…·</p>
    </footer>
  </div>

  <script>
    // åˆå§‹åŒ– CodeMirror ç¼–è¾‘å™¨
    let cmEditor;
    let lastOutputText = '';
    let currentViewMode = 'tree'; // 'tree' æˆ– 'text'
    let currentJsonData = null; // å½“å‰è§£æçš„ JSON æ•°æ®
    let currentOperation = ''; // 'format', 'minify', 'escape'

    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ– CodeMirror
      const inputTextarea = document.getElementById('input-editor');
      cmEditor = CodeMirror.fromTextArea(inputTextarea, {
        mode: { name: 'javascript', json: true },
        lineNumbers: true,
        theme: 'material-darker',
        lineWrapping: true,
        tabSize: 2,
        indentWithTabs: false,
        scrollbarStyle: 'native',
        viewportMargin: Infinity
      });

      // è·å–å…ƒç´ 
      const outputViewer = document.getElementById('output-viewer');
      const formatBtn = document.getElementById('format-btn');
      const minifyBtn = document.getElementById('minify-btn');
      const escapeBtn = document.getElementById('escape-btn');
      const clearBtn = document.getElementById('clear-btn');
      const exampleBtn = document.getElementById('example-btn');
      const copyInputBtn = document.getElementById('copy-input-btn');
      const copyOutputBtn = document.getElementById('copy-output-btn');
      const indentSize = document.getElementById('indent-size');
      const statusBar = document.getElementById('status-bar');
      const inputStats = document.getElementById('input-stats');
      const outputStats = document.getElementById('output-stats');
      const currentYearElement = document.getElementById('current-year');
      const viewModeSelect = document.getElementById('view-mode');
      const collapseAllBtn = document.getElementById('collapse-all-btn');
      const expandAllBtn = document.getElementById('expand-all-btn');

      // è®¾ç½®å½“å‰å¹´ä»½
      currentYearElement.textContent = new Date().getFullYear();

      // ç¤ºä¾‹ JSON æ•°æ®
      const exampleJSON = {
        "name": "JSON æ ¼å¼åŒ–å·¥å…·",
        "version": "2.0.0",
        "description": "ç®€æ´é«˜æ•ˆçš„ JSON æ ¼å¼åŒ–å’ŒéªŒè¯å·¥å…·",
        "features": [
          "æ™ºèƒ½æ ¼å¼åŒ–",
          "è¯­æ³•éªŒè¯",
          "ä¸€é”®å‹ç¼©",
          "è½¬ä¹‰å¤„ç†",
          "è¯­æ³•é«˜äº®",
          "è¡Œå·æ˜¾ç¤º"
        ],
        "settings": {
          "indentSize": 2,
          "theme": "dark",
          "autoFormat": true
        },
        "stats": {
          "downloads": 15000,
          "activeUsers": 8500,
          "rating": 4.9
        },
        "author": {
          "name": "å¼€å‘è€…",
          "website": "https://example.com",
          "contact": {
            "email": "dev@example.com",
            "github": "@jsonformatter"
          }
        },
        "license": "MIT",
        "isActive": true,
        "testNull": null
      };

      // æ›´æ–°å­—ç¬¦ç»Ÿè®¡
      function updateStats() {
        const inputLen = cmEditor.getValue().length;
        const outputLen = lastOutputText.length;
        inputStats.textContent = `${inputLen} å­—ç¬¦`;
        outputStats.textContent = `${outputLen} å­—ç¬¦`;
      }

      // è®¾ç½®çŠ¶æ€æ ä¿¡æ¯
      function setStatus(message, type) {
        statusBar.textContent = message;
        statusBar.className = 'status-bar';
        if (type) {
          statusBar.classList.add(type);
        }
        
        // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
        if (type === 'success') {
          setTimeout(() => {
            statusBar.style.display = 'none';
          }, 3000);
        }
      }

      // ==================== æ ‘çŠ¶è§†å›¾åŠŸèƒ½ ====================
      
      // æ„å»ºæ ‘çŠ¶èŠ‚ç‚¹æ•°æ®ç»“æ„
      function buildTreeNode(value, key = null, depth = 0) {
        const node = {
          key: key,
          value: value,
          depth: depth,
          collapsed: depth > 1, // é»˜è®¤æŠ˜å æ·±åº¦ > 1 çš„èŠ‚ç‚¹
          rendered: false
        };

        if (value === null) {
          node.type = 'null';
        } else if (Array.isArray(value)) {
          node.type = 'array';
          node.children = [];
          // æ‡’åŠ è½½ï¼šä»…åœ¨éœ€è¦æ—¶æ„å»ºå­èŠ‚ç‚¹
          node.childrenData = value;
        } else if (typeof value === 'object') {
          node.type = 'object';
          node.children = [];
          // æ‡’åŠ è½½ï¼šä»…åœ¨éœ€è¦æ—¶æ„å»ºå­èŠ‚ç‚¹
          node.childrenData = value;
        } else if (typeof value === 'string') {
          node.type = 'string';
        } else if (typeof value === 'number') {
          node.type = 'number';
        } else if (typeof value === 'boolean') {
          node.type = 'boolean';
        }

        return node;
      }

      // æ„å»ºå­èŠ‚ç‚¹ï¼ˆæ‡’åŠ è½½è°ƒç”¨ï¼‰
      function buildChildren(node) {
        if (node.rendered) return;
        
        node.children = [];
        if (node.type === 'array') {
          node.childrenData.forEach((item, index) => {
            node.children.push(buildTreeNode(item, index, node.depth + 1));
          });
        } else if (node.type === 'object') {
          Object.keys(node.childrenData).forEach(key => {
            node.children.push(buildTreeNode(node.childrenData[key], key, node.depth + 1));
          });
        }
        node.rendered = true;
      }

      // æ¸²æŸ“æ ‘çŠ¶èŠ‚ç‚¹
      function renderTreeNode(node, isRoot = false) {
        const container = document.createElement('div');
        container.className = 'tree-node';
        container.dataset.depth = node.depth;

        const content = document.createElement('div');
        content.className = 'tree-node-content';

        // æŠ˜å /å±•å¼€æŒ‰é’®
        const toggle = document.createElement('span');
        toggle.className = 'tree-toggle';
        if (node.type === 'object' || node.type === 'array') {
          toggle.className += node.collapsed ? ' collapsed' : ' expanded';
          toggle.onclick = function(e) {
            e.stopPropagation();
            toggleNode(node, container);
          };
        } else {
          toggle.className += ' no-toggle';
        }
        content.appendChild(toggle);

        // èŠ‚ç‚¹å†…å®¹
        const textSpan = document.createElement('span');
        
        if (node.key !== null) {
          const keySpan = document.createElement('span');
          keySpan.className = 'tree-key';
          keySpan.textContent = `"${node.key}"`;
          textSpan.appendChild(keySpan);
          
          const colonSpan = document.createElement('span');
          colonSpan.className = 'tree-colon';
          colonSpan.textContent = ': ';
          textSpan.appendChild(colonSpan);
        }

        const valueSpan = document.createElement('span');
        
        if (node.type === 'object') {
          const bracket = document.createElement('span');
          bracket.className = 'tree-bracket';
          const keys = Object.keys(node.childrenData);
          bracket.textContent = node.collapsed ? `{ ... }` : '{';
          if (keys.length === 0) {
            bracket.textContent = '{ }';
          } else if (!node.collapsed && keys.length > 0) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'tree-ellipsis';
            ellipsis.textContent = ` // ${keys.length} keys`;
            bracket.appendChild(ellipsis);
          }
          valueSpan.appendChild(bracket);
        } else if (node.type === 'array') {
          const bracket = document.createElement('span');
          bracket.className = 'tree-bracket';
          const len = node.childrenData.length;
          bracket.textContent = node.collapsed ? `[ ... ]` : '[';
          if (len === 0) {
            bracket.textContent = '[ ]';
          } else if (!node.collapsed && len > 0) {
            const ellipsis = document.createElement('span');
            ellipsis.className = 'tree-ellipsis';
            ellipsis.textContent = ` // ${len} items`;
            bracket.appendChild(ellipsis);
          }
          valueSpan.appendChild(bracket);
        } else if (node.type === 'string') {
          valueSpan.className = 'tree-value string';
          const str = node.value;
          valueSpan.textContent = `"${str.length > 100 ? str.substring(0, 100) + '...' : str}"`;
          if (str.length > 100) {
            valueSpan.title = str;
          }
        } else if (node.type === 'number') {
          valueSpan.className = 'tree-value number';
          valueSpan.textContent = node.value;
        } else if (node.type === 'boolean') {
          valueSpan.className = 'tree-value boolean';
          valueSpan.textContent = node.value;
        } else if (node.type === 'null') {
          valueSpan.className = 'tree-value null';
          valueSpan.textContent = 'null';
        }

        textSpan.appendChild(valueSpan);
        content.appendChild(textSpan);

        // å¤åˆ¶æŒ‰é’®ï¼ˆä»…å¯¹å¯¹è±¡å’Œæ•°ç»„ï¼‰
        if (node.type === 'object' || node.type === 'array') {
          const copyBtn = document.createElement('button');
          copyBtn.className = 'tree-copy-btn';
          copyBtn.textContent = 'å¤åˆ¶';
          copyBtn.onclick = function(e) {
            e.stopPropagation();
            copyNodeData(node);
          };
          content.appendChild(copyBtn);
        }

        container.appendChild(content);

        // å­èŠ‚ç‚¹å®¹å™¨
        if (node.type === 'object' || node.type === 'array') {
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'tree-children';
          if (node.collapsed) {
            childrenContainer.className += ' collapsed';
          } else {
            // æ‡’åŠ è½½ï¼šå±•å¼€æ—¶æ‰æ„å»ºå­èŠ‚ç‚¹
            if (!node.rendered) {
              buildChildren(node);
            }
            node.children.forEach(child => {
              childrenContainer.appendChild(renderTreeNode(child));
            });
            
            // é—­åˆæ‹¬å·
            const closeBracket = document.createElement('div');
            closeBracket.className = 'tree-node-content';
            closeBracket.style.marginLeft = '0';
            const closeBracketSpan = document.createElement('span');
            closeBracketSpan.className = 'tree-bracket';
            closeBracketSpan.textContent = node.type === 'object' ? '}' : ']';
            closeBracket.appendChild(closeBracketSpan);
            childrenContainer.appendChild(closeBracket);
          }
          container.appendChild(childrenContainer);
        }

        return container;
      }

      // æŠ˜å /å±•å¼€èŠ‚ç‚¹
      function toggleNode(node, container) {
        node.collapsed = !node.collapsed;
        
        const toggle = container.querySelector('.tree-toggle');
        const childrenContainer = container.querySelector('.tree-children');
        const valueSpan = container.querySelector('.tree-bracket');
        
        if (node.collapsed) {
          toggle.className = 'tree-toggle collapsed';
          childrenContainer.className = 'tree-children collapsed';
          if (node.type === 'object') {
            valueSpan.textContent = '{ ... }';
          } else if (node.type === 'array') {
            valueSpan.textContent = '[ ... ]';
          }
        } else {
          toggle.className = 'tree-toggle expanded';
          childrenContainer.className = 'tree-children';
          childrenContainer.innerHTML = '';
          
          // æ‡’åŠ è½½ï¼šå±•å¼€æ—¶æ„å»ºå­èŠ‚ç‚¹
          if (!node.rendered) {
            buildChildren(node);
          }
          
          node.children.forEach(child => {
            childrenContainer.appendChild(renderTreeNode(child));
          });
          
          // é—­åˆæ‹¬å·
          const closeBracket = document.createElement('div');
          closeBracket.className = 'tree-node-content';
          closeBracket.style.marginLeft = '0';
          const closeBracketSpan = document.createElement('span');
          closeBracketSpan.className = 'tree-bracket';
          closeBracketSpan.textContent = node.type === 'object' ? '}' : ']';
          closeBracket.appendChild(closeBracketSpan);
          childrenContainer.appendChild(closeBracket);
          
          // æ›´æ–°æ‹¬å·æ˜¾ç¤º
          if (node.type === 'object') {
            const keys = Object.keys(node.childrenData);
            valueSpan.textContent = '{';
            if (keys.length > 0) {
              const ellipsis = document.createElement('span');
              ellipsis.className = 'tree-ellipsis';
              ellipsis.textContent = ` // ${keys.length} keys`;
              valueSpan.appendChild(ellipsis);
            }
          } else if (node.type === 'array') {
            const len = node.childrenData.length;
            valueSpan.textContent = '[';
            if (len > 0) {
              const ellipsis = document.createElement('span');
              ellipsis.className = 'tree-ellipsis';
              ellipsis.textContent = ` // ${len} items`;
              valueSpan.appendChild(ellipsis);
            }
          }
        }
      }

      // å¤åˆ¶èŠ‚ç‚¹æ•°æ®
      function copyNodeData(node) {
        let data;
        if (node.type === 'object' || node.type === 'array') {
          data = node.childrenData;
        } else {
          data = node.value;
        }
        
        const jsonString = JSON.stringify(data, null, 2);
        copyToClipboard(jsonString, 'èŠ‚ç‚¹æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      }

      // å…¨éƒ¨æŠ˜å 
      function collapseAll(node) {
        if (node.type === 'object' || node.type === 'array') {
          node.collapsed = true;
          if (node.rendered && node.children) {
            node.children.forEach(child => collapseAll(child));
          }
        }
      }

      // å…¨éƒ¨å±•å¼€
      function expandAll(node) {
        if (node.type === 'object' || node.type === 'array') {
          node.collapsed = false;
          if (!node.rendered) {
            buildChildren(node);
          }
          node.children.forEach(child => expandAll(child));
        }
      }

      // æ¸²æŸ“æ ‘çŠ¶è§†å›¾
      function renderTreeView(jsonData, preserveState = false) {
        outputViewer.innerHTML = '';
        outputViewer.className = 'output-viewer tree-view';
        
        // å¦‚æœæ˜¯ä¿æŒçŠ¶æ€æ¨¡å¼ä¸”å·²æœ‰æ•°æ®ï¼Œç›´æ¥ä½¿ç”¨ç°æœ‰èŠ‚ç‚¹
        if (preserveState && currentJsonData) {
          outputViewer.appendChild(renderTreeNode(currentJsonData, true));
        } else {
          // åˆ›å»ºæ–°èŠ‚ç‚¹
          const rootNode = buildTreeNode(jsonData);
          rootNode.collapsed = false; // æ ¹èŠ‚ç‚¹é»˜è®¤å±•å¼€
          currentJsonData = rootNode;
          outputViewer.appendChild(renderTreeNode(rootNode, true));
        }
        
        // æ˜¾ç¤ºæŠ˜å /å±•å¼€æŒ‰é’®
        collapseAllBtn.style.display = 'inline-block';
        expandAllBtn.style.display = 'inline-block';
      }

      // ==================== çº¯æ–‡æœ¬è§†å›¾åŠŸèƒ½ ====================

      // é€’å½’å»é™¤è½¬ä¹‰
      function removeEscapes(str) {
        let result = str;
        let prevResult = '';
        
        // æŒç»­å»é™¤è½¬ä¹‰ç›´åˆ°æ²¡æœ‰å˜åŒ–
        while (result !== prevResult) {
          prevResult = result;
          result = result.replace(/\\"/g, '"');
        }
        
        return result;
      }

      // æ£€æµ‹å¹¶å¤„ç†å•å¼•å·å­—ç¬¦ä¸²ï¼ˆPython/JS æ ¼å¼è½¬æ¢ï¼‰
      function handleSingleQuotes(str) {
        str = str.trim();
        
        // æ£€æµ‹æ˜¯å¦æ˜¯å•å¼•å·åŒ…è£¹çš„å­—ç¬¦ä¸²
        if (str.startsWith("'") && str.endsWith("'")) {
          // å»é™¤é¦–å°¾å•å¼•å·
          str = str.slice(1, -1);
          // è½¬ä¹‰å†…éƒ¨çš„åŒå¼•å·
          str = str.replace(/"/g, '\\"');
          // ç”¨åŒå¼•å·åŒ…è£¹
          str = '"' + str + '"';
          
          // å°è¯•è§£æï¼Œå¦‚æœæ˜¯JSONå¯¹è±¡å­—ç¬¦ä¸²ï¼Œéœ€è¦å†å¤„ç†
          try {
            const parsed = JSON.parse(str);
            if (typeof parsed === 'string') {
              // æ˜¯å­—ç¬¦ä¸²å­—é¢é‡ï¼Œå°è¯•è§£æä¸ºJSON
              try {
                return JSON.parse(parsed);
              } catch (e) {
                return parsed;
              }
            }
          } catch (e) {
            // ä¸æ˜¯æœ‰æ•ˆçš„JSONï¼Œè¿”å›åŸå­—ç¬¦ä¸²
          }
        }
        
        return str;
      }

      // è·å– JSON è§£æé”™è¯¯çš„è¯¦ç»†ä½ç½®å’Œå»ºè®®
      function getDetailedError(jsonString, error) {
        const errorMsg = error.message;
        let position = -1;
        
        // å°è¯•ä»é”™è¯¯æ¶ˆæ¯ä¸­æå–ä½ç½®ä¿¡æ¯
        const positionMatch = errorMsg.match(/position (\d+)/);
        if (positionMatch) {
          position = parseInt(positionMatch[1]);
        }
        
        if (position === -1) {
          return {
            message: errorMsg,
            suggestion: 'è¯·æ£€æŸ¥ JSON è¯­æ³•æ˜¯å¦æ­£ç¡®'
          };
        }
        
        // è®¡ç®—è¡Œå·å’Œåˆ—å·
        const lines = jsonString.substring(0, position).split('\n');
        const line = lines.length;
        const column = lines[lines.length - 1].length + 1;
        
        // è·å–é”™è¯¯ä¸Šä¸‹æ–‡ï¼ˆå‰åå„2è¡Œï¼‰
        const allLines = jsonString.split('\n');
        const contextStart = Math.max(0, line - 3);
        const contextEnd = Math.min(allLines.length, line + 2);
        const contextLines = allLines.slice(contextStart, contextEnd);
        
        // ç”Ÿæˆé”™è¯¯æç¤º
        let detailedMessage = `JSON è§£æé”™è¯¯ï¼ˆç¬¬ ${line} è¡Œï¼Œç¬¬ ${column} åˆ—ï¼‰\n\n`;
        
        // æ˜¾ç¤ºä¸Šä¸‹æ–‡ä»£ç 
        contextLines.forEach((contextLine, idx) => {
          const lineNum = contextStart + idx + 1;
          const prefix = lineNum === line ? '>>> ' : '    ';
          detailedMessage += `${prefix}${lineNum}: ${contextLine}\n`;
        });
        
        detailedMessage += `\né”™è¯¯è¯¦æƒ…: ${errorMsg}`;
        
        // æ ¹æ®é”™è¯¯ç±»å‹æä¾›è§£å†³å»ºè®®
        let suggestion = '';
        if (errorMsg.includes('Unexpected token')) {
          if (errorMsg.includes('}')) {
            suggestion = 'å¯èƒ½åŸå› ï¼šå¤šä½™çš„é—­åˆæ‹¬å·ï¼Œæˆ–ç¼ºå°‘é€—å·åˆ†éš”ç¬¦';
          } else if (errorMsg.includes(']')) {
            suggestion = 'å¯èƒ½åŸå› ï¼šå¤šä½™çš„é—­åˆæ–¹æ‹¬å·ï¼Œæˆ–ç¼ºå°‘é€—å·åˆ†éš”ç¬¦';
          } else if (errorMsg.includes(',')) {
            suggestion = 'å¯èƒ½åŸå› ï¼šå¤šä½™çš„é€—å·ï¼ˆJSON ä¸å…è®¸æœ«å°¾é€—å·ï¼‰';
          } else if (errorMsg.includes("'")) {
            suggestion = 'å¯èƒ½åŸå› ï¼šä½¿ç”¨äº†å•å¼•å·ï¼ŒJSON å¿…é¡»ä½¿ç”¨åŒå¼•å·';
          } else {
            suggestion = 'å¯èƒ½åŸå› ï¼šè¯­æ³•é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ‹¬å·ã€å¼•å·ã€é€—å·æ˜¯å¦åŒ¹é…';
          }
        } else if (errorMsg.includes('Unexpected end')) {
          suggestion = 'å¯èƒ½åŸå› ï¼šJSON ç»“æ„ä¸å®Œæ•´ï¼Œç¼ºå°‘é—­åˆçš„æ‹¬å·æˆ–æ–¹æ‹¬å·';
        } else if (errorMsg.includes('Expected')) {
          suggestion = 'å¯èƒ½åŸå› ï¼šç¼ºå°‘å¿…è¦çš„è¯­æ³•å…ƒç´ ï¼Œå¦‚å†’å·ã€é€—å·æˆ–å¼•å·';
        } else {
          suggestion = 'å»ºè®®ï¼šæ£€æŸ¥ JSON æ ¼å¼æ˜¯å¦ç¬¦åˆæ ‡å‡†è§„èŒƒ';
        }
        
        return {
          message: detailedMessage,
          suggestion: suggestion,
          line: line,
          column: column
        };
      }

      // éªŒè¯ JSON æ ¼å¼
      function validateJSON(jsonString) {
        try {
          JSON.parse(jsonString);
          return { valid: true };
        } catch (error) {
          const errorInfo = getDetailedError(jsonString, error);
          return {
            valid: false,
            error: errorInfo
          };
        }
      }

      // æ ¼å¼åŒ– JSON
      function formatJSON() {
        let input = cmEditor.getValue().trim();
        
        if (!input) {
          setStatus('è¯·è¾“å…¥ JSON æ•°æ®', 'error');
          return;
        }

        viewModeSelect.value = 'tree';

        // æ­¥éª¤1: å¤„ç†å•å¼•å·å­—ç¬¦ä¸²ï¼ˆPython/JS æ ¼å¼è½¬æ¢ï¼‰
        let processedInput = handleSingleQuotes(input);
        
        // æ­¥éª¤2: é€’å½’å»é™¤è½¬ä¹‰
        let unescapedInput = removeEscapes(processedInput);
        
        // æ­¥éª¤3: å°è¯•å¤šç§è§£æç­–ç•¥
        let jsonObj = null;
        let parseSuccess = false;
        let lastError = null;
        
        // ç­–ç•¥1: å°è¯•è§£æå»è½¬ä¹‰åçš„å­—ç¬¦ä¸²
        const validation1 = validateJSON(unescapedInput);
        if (validation1.valid) {
          try {
            jsonObj = JSON.parse(unescapedInput);
            parseSuccess = true;
          } catch (e) {
            lastError = e;
          }
        } else {
          lastError = validation1.error;
        }
        
        // ç­–ç•¥2: å¦‚æœç­–ç•¥1å¤±è´¥ï¼Œå°è¯•ç›´æ¥è§£æåŸå­—ç¬¦ä¸²
        if (!parseSuccess) {
          const validation2 = validateJSON(processedInput);
          if (validation2.valid) {
            try {
              jsonObj = JSON.parse(processedInput);
              parseSuccess = true;
            } catch (e) {
              // ä¿æŒä½¿ç”¨ç¬¬ä¸€ä¸ªé”™è¯¯ä¿¡æ¯
            }
          }
        }
        
        // ç­–ç•¥3: å¦‚æœå‰ä¸¤ä¸ªç­–ç•¥éƒ½å¤±è´¥ï¼Œå°è¯•è§£æåŸå§‹è¾“å…¥
        if (!parseSuccess) {
          const validation3 = validateJSON(input);
          if (validation3.valid) {
            try {
              jsonObj = JSON.parse(input);
              parseSuccess = true;
            } catch (e) {
              // ä¿æŒä½¿ç”¨ç¬¬ä¸€ä¸ªé”™è¯¯ä¿¡æ¯
            }
          } else if (!lastError) {
            lastError = validation3.error;
          }
        }
        
        // æ ¹æ®è§£æç»“æœå¤„ç†
        if (parseSuccess && jsonObj !== null) {
          // æ ¼å¼åŒ–æˆåŠŸ
          const spaces = parseInt(indentSize.value) || 2;
          const formatted = JSON.stringify(jsonObj, null, spaces);
          
          // æ¸²æŸ“è¾“å‡º
          currentOperation = 'format';
          renderOutput(formatted, 'format');
          lastOutputText = formatted;
          
          setStatus('JSON æ ¼å¼åŒ–æˆåŠŸï¼', 'success');
          updateStats();
        } else {
          // æ ¼å¼åŒ–å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
          if (lastError && lastError.message) {
            let errorMsg = lastError.message;
            if (lastError.suggestion) {
              errorMsg += '\n\nğŸ’¡ ' + lastError.suggestion;
            }
            setStatus(errorMsg, 'error');
            
            // å¦‚æœæœ‰è¡Œå·ä¿¡æ¯ï¼Œé«˜äº®æ˜¾ç¤ºé”™è¯¯è¡Œ
            if (lastError.line) {
              cmEditor.setCursor(lastError.line - 1, lastError.column - 1);
              cmEditor.focus();
            }
          } else {
            setStatus('JSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®', 'error');
          }
        }
      }

      // å‹ç¼© JSON
      function minifyJSON() {
        let input = cmEditor.getValue().trim();
        
        if (!input) {
          setStatus('è¯·è¾“å…¥ JSON æ•°æ®', 'error');
          return;
        }

        // å¤„ç†å•å¼•å·å’Œè½¬ä¹‰
        let processedInput = handleSingleQuotes(input);
        let unescapedInput = removeEscapes(processedInput);
        
        // å°è¯•å¤šç§è§£æç­–ç•¥
        let jsonObj = null;
        let parseSuccess = false;
        let lastError = null;
        
        // ç­–ç•¥1: è§£æå»è½¬ä¹‰åçš„å­—ç¬¦ä¸²
        const validation1 = validateJSON(unescapedInput);
        if (validation1.valid) {
          try {
            jsonObj = JSON.parse(unescapedInput);
            parseSuccess = true;
          } catch (e) {
            lastError = e;
          }
        } else {
          lastError = validation1.error;
        }
        
        // ç­–ç•¥2: è§£æå¤„ç†åçš„å­—ç¬¦ä¸²
        if (!parseSuccess) {
          const validation2 = validateJSON(processedInput);
          if (validation2.valid) {
            try {
              jsonObj = JSON.parse(processedInput);
              parseSuccess = true;
            } catch (e) {
              // ä¿æŒç¬¬ä¸€ä¸ªé”™è¯¯
            }
          }
        }
        
        // ç­–ç•¥3: è§£æåŸå§‹è¾“å…¥
        if (!parseSuccess) {
          const validation3 = validateJSON(input);
          if (validation3.valid) {
            try {
              jsonObj = JSON.parse(input);
              parseSuccess = true;
            } catch (e) {
              // ä¿æŒç¬¬ä¸€ä¸ªé”™è¯¯
            }
          } else if (!lastError) {
            lastError = validation3.error;
          }
        }
        
        if (parseSuccess && jsonObj !== null) {
          // å‹ç¼©
          const minified = JSON.stringify(jsonObj);
          
          // å‹ç¼©æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°çº¯æ–‡æœ¬è§†å›¾
          viewModeSelect.value = 'text';
          
          // æ¸²æŸ“è¾“å‡º
          currentOperation = 'minify';
          renderOutput(minified, 'minify');
          lastOutputText = minified;
          
          setStatus('JSON å‹ç¼©æˆåŠŸï¼', 'success');
          updateStats();
        } else {
          // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
          if (lastError && lastError.message) {
            let errorMsg = lastError.message;
            if (lastError.suggestion) {
              errorMsg += '\n\nğŸ’¡ ' + lastError.suggestion;
            }
            setStatus(errorMsg, 'error');
            
            if (lastError.line) {
              cmEditor.setCursor(lastError.line - 1, lastError.column - 1);
              cmEditor.focus();
            }
          } else {
            setStatus('JSON è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®', 'error');
          }
        }
      }

      // è½¬ä¹‰ JSON
      function escapeJSON() {
        const input = cmEditor.getValue().trim();
        
        if (!input) {
          setStatus('è¯·è¾“å…¥ JSON æ•°æ®', 'error');
          return;
        }

        // è½¬ä¹‰åŒå¼•å·
        const escaped = input.replace(/\\"/g, '\\\\"').replace(/([^\\])"/g, '$1\\"');
        
        // æ¸²æŸ“è¾“å‡º
        currentOperation = 'escape';
        renderOutput(escaped, 'escape');
        lastOutputText = escaped;
        
        setStatus('JSON è½¬ä¹‰æˆåŠŸï¼', 'success');
        updateStats();
      }

      // æ¸²æŸ“è¾“å‡ºï¼ˆä½¿ç”¨ highlight.js å’Œè¡Œå·æ’ä»¶ï¼‰
      function renderOutput(text, mode = 'format') {
        currentViewMode = viewModeSelect.value;
        
        // å¦‚æœæ˜¯æ ‘çŠ¶è§†å›¾æ¨¡å¼ä¸”ä¸æ˜¯è½¬ä¹‰æ“ä½œ
        if (currentViewMode === 'tree' && mode !== 'escape') {
          try {
            const jsonData = JSON.parse(text);
            renderTreeView(jsonData);
            return;
          } catch (e) {
            // è§£æå¤±è´¥ï¼Œé™çº§ä¸ºçº¯æ–‡æœ¬æ¨¡å¼
            console.error('Tree view parse error:', e);
          }
        }
        
        // çº¯æ–‡æœ¬æ¨¡å¼
        outputViewer.innerHTML = '';
        outputViewer.className = 'output-viewer';
        
        // å¦‚æœæ˜¯å‹ç¼©æ¨¡å¼ï¼Œæ·»åŠ  minified ç±»
        if (mode === 'minify') {
          outputViewer.classList.add('minified');
        }
        
        const pre = document.createElement('pre');
        const code = document.createElement('code');
        code.className = 'language-json';
        code.textContent = text;
        
        pre.appendChild(code);
        outputViewer.appendChild(pre);
        
        // åº”ç”¨è¯­æ³•é«˜äº®
        if (window.hljs) {
          hljs.highlightElement(code);
          
          // åº”ç”¨è¡Œå·
          if (window.hljs.lineNumbersBlock) {
            hljs.lineNumbersBlock(code);
          }
        }
        
        // éšè—æŠ˜å /å±•å¼€æŒ‰é’®
        collapseAllBtn.style.display = 'none';
        expandAllBtn.style.display = 'none';
      }

      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      function copyToClipboard(text, successMessage) {
        if (navigator.clipboard) {
          navigator.clipboard.writeText(text)
            .then(() => {
              setStatus(successMessage, 'success');
            })
            .catch(err => {
              setStatus('å¤åˆ¶å¤±è´¥: ' + err, 'error');
            });
        } else {
          // é™çº§æ–¹æ¡ˆ
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          try {
            document.execCommand('copy');
            setStatus(successMessage, 'success');
          } catch (err) {
            setStatus('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
          }
          document.body.removeChild(textarea);
        }
      }

      // å¤åˆ¶è¾“å…¥å†…å®¹
      function copyInput() {
        const input = cmEditor.getValue();
        if (!input) {
          setStatus('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶', 'error');
          return;
        }
        copyToClipboard(input, 'è¾“å…¥å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      }

      // å¤åˆ¶è¾“å‡ºå†…å®¹
      function copyOutput() {
        if (!lastOutputText) {
          setStatus('æ²¡æœ‰å†…å®¹å¯å¤åˆ¶', 'error');
          return;
        }
        copyToClipboard(lastOutputText, 'è¾“å‡ºå†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      }

      // æ¸…ç©ºæ‰€æœ‰å†…å®¹
      function clearAll() {
        cmEditor.setValue('');
        outputViewer.innerHTML = '';
        outputViewer.className = 'output-viewer';
        lastOutputText = '';
        currentJsonData = null;
        currentOperation = '';
        statusBar.style.display = 'none';
        collapseAllBtn.style.display = 'none';
        expandAllBtn.style.display = 'none';
        updateStats();
      }

      // åŠ è½½ç¤ºä¾‹æ•°æ®
      function loadExample() {
        cmEditor.setValue(JSON.stringify(exampleJSON, null, 2));
        updateStats();
        formatJSON();
      }

      // äº‹ä»¶ç›‘å¬
      formatBtn.addEventListener('click', formatJSON);
      minifyBtn.addEventListener('click', minifyJSON);
      escapeBtn.addEventListener('click', escapeJSON);
      clearBtn.addEventListener('click', clearAll);
      exampleBtn.addEventListener('click', loadExample);
      copyInputBtn.addEventListener('click', copyInput);
      copyOutputBtn.addEventListener('click', copyOutput);
      
      // è§†å›¾æ¨¡å¼åˆ‡æ¢
      viewModeSelect.addEventListener('change', function() {
        if (lastOutputText && currentOperation !== 'escape') {
          // é‡æ–°æ¸²æŸ“å½“å‰æ•°æ®
          renderOutput(lastOutputText, currentOperation);
        }
      });
      
      // å…¨éƒ¨æŠ˜å 
      collapseAllBtn.addEventListener('click', function() {
        if (currentJsonData) {
          collapseAll(currentJsonData);
          // é‡æ–°æ¸²æŸ“ï¼šä¿æŒèŠ‚ç‚¹çŠ¶æ€
          renderTreeView(null, true);
        }
      });
      
      // å…¨éƒ¨å±•å¼€
      expandAllBtn.addEventListener('click', function() {
        if (currentJsonData) {
          expandAll(currentJsonData);
          // é‡æ–°æ¸²æŸ“ï¼šä¿æŒèŠ‚ç‚¹çŠ¶æ€
          renderTreeView(null, true);
        }
      });

      // CodeMirror å˜åŒ–ç›‘å¬
      cmEditor.on('change', function() {
        updateStats();
      });

      // å¿«æ·é”®æ”¯æŒ Ctrl+Enter æ ¼å¼åŒ–
      cmEditor.addKeyMap({
        'Ctrl-Enter': formatJSON
      });

      // æ‹–æ‹½æ–‡ä»¶æ”¯æŒ
      const cmWrapper = cmEditor.getWrapperElement();
      cmWrapper.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      
      cmWrapper.addEventListener('drop', function(e) {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(event) {
            cmEditor.setValue(event.target.result);
            updateStats();
          };
          reader.readAsText(file);
        }
      });

      // åˆå§‹åŒ–ç»Ÿè®¡
      updateStats();
    });
  </script>
</body>
</html>
