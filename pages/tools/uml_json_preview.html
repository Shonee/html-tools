<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>JSON å¯è§†åŒ–ï¼ˆç®€åŒ–ç‰ˆï¼‰</title>
  <!-- CodeMirror æ ·å¼ -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css"
  />
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      display:flex;
      height:100vh;
      font-family: sans-serif;
      background:#2d2d2d;
      color:#eee;
    }
    /* å·¦ä¾§ç¼–è¾‘åŒº */
    #editorContainer { width:40%; border-right:1px solid #444; }
    .CodeMirror { height:100%; }
    /* å³ä¾§é¢„è§ˆåŒº */
    #previewContainer {
      flex:1; display:flex; flex-direction:column; padding:20px;
      background:#f7f7f7;
    }
    #errorMsg { height:24px; color:#d00; font-size:14px }
    #diagram {
      flex:1; margin-top:8px; overflow:auto; background:#fff;
      border:1px solid #ccc; border-radius:4px;
      display:flex; align-items:center; justify-content:center;
    }
    #diagram img { max-width:100%; height:auto }
    #download {
      display:none; margin-top:8px; text-decoration:none;
      background:#4a90e2; color:#fff; padding:6px 12px; border-radius:4px;
    }
    #download:hover { background:#357ab8 }
  </style>
</head>
<body>
  <!-- å·¦ï¼šJSON ç¼–è¾‘å™¨ -->
  <div id="editorContainer">
    <textarea id="jsonInput" placeholder="ç²˜è´´æˆ–è¾“å…¥ JSONâ€¦"> 
    {
        "<color:blue><b>code": "<color:blue><b>value",
        "a\\u005Cb": "a\\b",
        "\\uD83D\\uDE10": "ğŸ˜",
        "ğŸ˜": "ğŸ˜"
    } 
    </textarea>
  </div>
  <!-- å³ï¼šæŠ¥é”™ï¼æ¸²æŸ“ï¼ä¸‹è½½ -->
  <div id="previewContainer">
    <div id="errorMsg">ç­‰å¾… JSON è¾“å…¥â€¦</div>
    <div id="diagram">æš‚æ— å†…å®¹</div>
    <a id="download" download="diagram.svg">ä¸‹è½½ SVG</a>
  </div>

  <!-- å¼•å…¥ä¾èµ–ï¼šCodeMirror + PlantUML ç¼–ç å™¨ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://unpkg.com/plantuml-encoder/dist/plantuml-encoder.min.js"></script>
  <script>
    const SERVER = 'https://www.plantuml.com/plantuml/svg/';
    // åˆå§‹åŒ– CodeMirror
    const editor = CodeMirror.fromTextArea(
      document.getElementById('jsonInput'), {
        mode: { name:'javascript', json:true },
        theme:'dracula',
        lineNumbers:true,
        tabSize:2
      }
    );

    const errorEl  = document.getElementById('errorMsg');
    const diagramEl= document.getElementById('diagram');
    const dl       = document.getElementById('download');

    function render() {
      const raw = editor.getValue();
      try {
        // è§£æ & ç¾åŒ–
        const obj = JSON.parse(raw);
        const pretty = JSON.stringify(obj, null, 2);
        if (pretty !== raw) editor.setValue(pretty);
        errorEl.textContent = '';

        // æœ€ç®€ PlantUML è„šæœ¬
        const puml = ['@startjson', pretty, '@endjson'].join('\n');
        const code = plantumlEncoder.encode(puml);
        const imgUrl = SERVER + code;

        // æ¸²æŸ“å›¾ç‰‡
        const img = new Image();
        img.onload = () => {
          diagramEl.innerHTML = '';
          diagramEl.appendChild(img);
          // ç”Ÿæˆä¸‹è½½é“¾æ¥
          fetch(imgUrl)
            .then(r=>r.blob())
            .then(b=>{
              dl.href = URL.createObjectURL(b);
              dl.style.display = 'inline-block';
            });
        };
        img.onerror = () => {
          errorEl.textContent = 'âš ï¸ æ¸²æŸ“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡';
        };
        img.src = imgUrl;
      } catch (e) {
        // å®šä½é”™è¯¯è¡Œå·
        let pos = (e.message.match(/position\s*(\d+)/) || [])[1];
        let lineInfo = '';
        if (pos !== undefined) {
          const l = editor.getValue().slice(0, +pos).split('\n').length;
          lineInfo = `ï¼ˆç¬¬ ${l} è¡Œï¼‰`;
        }
        errorEl.textContent = `âŒ è§£æé”™è¯¯ï¼š${e.message}${lineInfo}`;
        diagramEl.innerHTML = 'ä¿®æ­£ JSON åè‡ªåŠ¨æ›´æ–°';
        dl.style.display = 'none';
      }
    }

    // 500ms é˜²æŠ–æ›´æ–°
    let tid;
    editor.on('change', ()=>{
      clearTimeout(tid);
      tid = setTimeout(render, 500);
    });
    editor.on('paste', ()=>{
      clearTimeout(tid);
      tid = setTimeout(render, 200);
    });
  </script>
</body>
</html>
