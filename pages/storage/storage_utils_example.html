<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StorageUtils ä½¿ç”¨ç¤ºä¾‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #1e293b;
      margin-bottom: 12px;
      font-size: 32px;
    }

    .env-info {
      background: #f1f5f9;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      border-left: 4px solid #3b82f6;
    }

    .env-info strong {
      color: #3b82f6;
    }

    .section {
      margin-bottom: 32px;
    }

    .section h2 {
      color: #475569;
      margin-bottom: 16px;
      font-size: 20px;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 8px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-info {
      background: #06b6d4;
      color: white;
    }

    .output {
      background: #1e293b;
      color: #e2e8f0;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .output:empty::before {
      content: 'ç­‰å¾…æ“ä½œè¾“å‡º...';
      color: #64748b;
    }

    input {
      padding: 10px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      max-width: 300px;
      transition: border-color 0.2s;
    }

    input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .input-group {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .input-group label {
      color: #475569;
      font-weight: 500;
      min-width: 80px;
    }

    .success {
      color: #10b981;
    }

    .error {
      color: #ef4444;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ—„ï¸ StorageUtils ä½¿ç”¨ç¤ºä¾‹</h1>
    <div class="env-info" id="envInfo">
      <strong>è¿è¡Œç¯å¢ƒï¼š</strong>åŠ è½½ä¸­...
    </div>

    <!-- åŸºç¡€æ“ä½œ -->
    <div class="section">
      <h2>ğŸ“ åŸºç¡€æ“ä½œ (å¢åˆ æ”¹æŸ¥)</h2>
      
      <div class="input-group">
        <label>é”®åï¼š</label>
        <input type="text" id="keyInput" placeholder="ä¾‹å¦‚ï¼šusername" value="testKey">
        <label>å€¼ï¼š</label>
        <input type="text" id="valueInput" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰" value="Hello World">
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="testSet()">ğŸ’¾ è®¾ç½®æ•°æ® (set)</button>
        <button class="btn-success" onclick="testGet()">ğŸ” è·å–æ•°æ® (get)</button>
        <button class="btn-warning" onclick="testUpdate()">âœï¸ æ›´æ–°æ•°æ® (update)</button>
        <button class="btn-danger" onclick="testRemove()">ğŸ—‘ï¸ åˆ é™¤æ•°æ® (remove)</button>
      </div>

      <div class="output" id="basicOutput"></div>
    </div>

    <!-- æ‰¹é‡æ“ä½œ -->
    <div class="section">
      <h2>ğŸ“¦ æ‰¹é‡æ“ä½œ</h2>
      
      <div class="button-group">
        <button class="btn-primary" onclick="testBatchSet()">æ‰¹é‡è®¾ç½® (setBatch)</button>
        <button class="btn-success" onclick="testBatchGet()">æ‰¹é‡è·å– (getBatch)</button>
        <button class="btn-danger" onclick="testBatchRemove()">æ‰¹é‡åˆ é™¤ (removeBatch)</button>
      </div>

      <div class="output" id="batchOutput"></div>
    </div>

    <!-- æŸ¥è¯¢æ“ä½œ -->
    <div class="section">
      <h2>ğŸ” æŸ¥è¯¢æ“ä½œ</h2>
      
      <div class="button-group">
        <button class="btn-info" onclick="testGetAllKeys()">è·å–æ‰€æœ‰é”® (getAllKeys)</button>
        <button class="btn-info" onclick="testHas()">æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ (has)</button>
        <button class="btn-info" onclick="testGetBytesInUse()">è·å–å­˜å‚¨å¤§å° (getBytesInUse)</button>
      </div>

      <div class="output" id="queryOutput"></div>
    </div>

    <!-- é«˜çº§æ“ä½œ -->
    <div class="section">
      <h2>âš™ï¸ é«˜çº§æ“ä½œ</h2>
      
      <div class="button-group">
        <button class="btn-warning" onclick="testOnChanged()">ç›‘å¬å˜åŒ– (onChanged)</button>
        <button class="btn-warning" onclick="stopListening()">åœæ­¢ç›‘å¬</button>
        <button class="btn-danger" onclick="testClear()">æ¸…ç©ºæ‰€æœ‰æ•°æ® (clear)</button>
      </div>

      <div class="output" id="advancedOutput"></div>
    </div>

    <!-- ç¯å¢ƒä¿¡æ¯ -->
    <div class="section">
      <h2>â„¹ï¸ ç¯å¢ƒä¿¡æ¯</h2>
      <div class="output" id="envOutput"></div>
    </div>
  </div>

  <script src="storage_utils.js"></script>
  <script>
    let unsubscribe = null;

    // åˆå§‹åŒ–æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    window.addEventListener('DOMContentLoaded', () => {
      displayEnvInfo();
      displayDetailedEnvInfo();
    });

    function log(elementId, message, type = 'info') {
      const output = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      const typeSymbol = type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸';
      output.innerHTML += `[${timestamp}] ${typeSymbol} ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    function clearLog(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }

    function displayEnvInfo() {
      const info = StorageUtils.getEnvironmentInfo();
      const envInfo = document.getElementById('envInfo');
      envInfo.innerHTML = `
        <strong>è¿è¡Œç¯å¢ƒï¼š</strong>${info.isExtension ? 'ğŸ”Œ Chrome æ‰©å±•' : 'ğŸŒ æ™®é€š HTML é¡µé¢'} (${info.type})
      `;
    }

    function displayDetailedEnvInfo() {
      const info = StorageUtils.getEnvironmentInfo();
      const envOutput = document.getElementById('envOutput');
      envOutput.textContent = JSON.stringify(info, null, 2);
    }

    // åŸºç¡€æ“ä½œ
    async function testSet() {
      clearLog('basicOutput');
      const key = document.getElementById('keyInput').value;
      const value = document.getElementById('valueInput').value;
      
      try {
        await StorageUtils.set(key, value);
        log('basicOutput', `æˆåŠŸè®¾ç½® ${key} = "${value}"`, 'success');
      } catch (error) {
        log('basicOutput', `è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testGet() {
      clearLog('basicOutput');
      const key = document.getElementById('keyInput').value;
      
      try {
        const value = await StorageUtils.get(key);
        log('basicOutput', `${key} = ${JSON.stringify(value)}`, 'success');
      } catch (error) {
        log('basicOutput', `è·å–å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testUpdate() {
      clearLog('basicOutput');
      const key = document.getElementById('keyInput').value;
      
      try {
        // å…ˆè®¾ç½®ä¸€ä¸ªå¯¹è±¡
        await StorageUtils.set(key, { name: 'å¼ ä¸‰', age: 25 });
        log('basicOutput', `åˆå§‹æ•°æ®ï¼š{ name: 'å¼ ä¸‰', age: 25 }`);
        
        // æ›´æ–°éƒ¨åˆ†å­—æ®µ
        await StorageUtils.update(key, { age: 26, city: 'åŒ—äº¬' });
        const updated = await StorageUtils.get(key);
        log('basicOutput', `æ›´æ–°åï¼š${JSON.stringify(updated)}`, 'success');
      } catch (error) {
        log('basicOutput', `æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testRemove() {
      clearLog('basicOutput');
      const key = document.getElementById('keyInput').value;
      
      try {
        await StorageUtils.remove(key);
        log('basicOutput', `æˆåŠŸåˆ é™¤ ${key}`, 'success');
        
        const value = await StorageUtils.get(key);
        log('basicOutput', `éªŒè¯åˆ é™¤ï¼š${key} = ${value}`);
      } catch (error) {
        log('basicOutput', `åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æ‰¹é‡æ“ä½œ
    async function testBatchSet() {
      clearLog('batchOutput');
      
      try {
        const data = {
          user1: { name: 'å¼ ä¸‰', age: 25 },
          user2: { name: 'æå››', age: 30 },
          user3: { name: 'ç‹äº”', age: 35 }
        };
        
        await StorageUtils.setBatch(data);
        log('batchOutput', `æˆåŠŸæ‰¹é‡è®¾ç½® 3 æ¡æ•°æ®ï¼š`, 'success');
        log('batchOutput', JSON.stringify(data, null, 2));
      } catch (error) {
        log('batchOutput', `æ‰¹é‡è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testBatchGet() {
      clearLog('batchOutput');
      
      try {
        const keys = ['user1', 'user2', 'user3'];
        const result = await StorageUtils.getBatch(keys);
        
        log('batchOutput', `æ‰¹é‡è·å–ç»“æœï¼š`, 'success');
        log('batchOutput', JSON.stringify(result, null, 2));
      } catch (error) {
        log('batchOutput', `æ‰¹é‡è·å–å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testBatchRemove() {
      clearLog('batchOutput');
      
      try {
        const keys = ['user1', 'user2', 'user3'];
        await StorageUtils.removeBatch(keys);
        log('batchOutput', `æˆåŠŸæ‰¹é‡åˆ é™¤: ${keys.join(', ')}`, 'success');
      } catch (error) {
        log('batchOutput', `æ‰¹é‡åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // æŸ¥è¯¢æ“ä½œ
    async function testGetAllKeys() {
      clearLog('queryOutput');
      
      try {
        const keys = await StorageUtils.getAllKeys();
        log('queryOutput', `å…±æœ‰ ${keys.length} ä¸ªé”®ï¼š`, 'success');
        log('queryOutput', JSON.stringify(keys, null, 2));
      } catch (error) {
        log('queryOutput', `è·å–å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testHas() {
      clearLog('queryOutput');
      const key = document.getElementById('keyInput').value;
      
      try {
        const exists = await StorageUtils.has(key);
        log('queryOutput', `é”® "${key}" ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, exists ? 'success' : 'error');
      } catch (error) {
        log('queryOutput', `æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
      }
    }

    async function testGetBytesInUse() {
      clearLog('queryOutput');
      
      try {
        const result = await StorageUtils.getBytesInUse();
        if (result.error) {
          log('queryOutput', result.error, 'error');
        } else {
          log('queryOutput', `å­˜å‚¨ä½¿ç”¨é‡ï¼š${result.bytesInUse} å­—èŠ‚ (çº¦ ${(result.bytesInUse / 1024).toFixed(2)} KB)`, 'success');
        }
      } catch (error) {
        log('queryOutput', `è·å–å¤±è´¥: ${error.message}`, 'error');
      }
    }

    // é«˜çº§æ“ä½œ
    function testOnChanged() {
      clearLog('advancedOutput');
      
      if (unsubscribe) {
        log('advancedOutput', 'ç›‘å¬å™¨å·²åœ¨è¿è¡Œä¸­', 'error');
        return;
      }

      unsubscribe = StorageUtils.onChanged((changes, areaName) => {
        log('advancedOutput', `æ£€æµ‹åˆ° ${areaName} å­˜å‚¨å˜åŒ–ï¼š`);
        Object.keys(changes).forEach(key => {
          const change = changes[key];
          log('advancedOutput', `  ${key}:`);
          log('advancedOutput', `    æ—§å€¼: ${JSON.stringify(change.oldValue)}`);
          log('advancedOutput', `    æ–°å€¼: ${JSON.stringify(change.newValue)}`);
        });
      });
      
      log('advancedOutput', 'âœ… ç›‘å¬å™¨å·²å¯åŠ¨ï¼Œç°åœ¨ä¿®æ”¹æ•°æ®å¯ä»¥çœ‹åˆ°å˜åŒ–', 'success');
      log('advancedOutput', 'æç¤ºï¼šå°è¯•ç‚¹å‡»ä¸Šé¢çš„"è®¾ç½®æ•°æ®"æŒ‰é’®');
    }

    function stopListening() {
      clearLog('advancedOutput');
      
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
        log('advancedOutput', 'âœ… ç›‘å¬å™¨å·²åœæ­¢', 'success');
      } else {
        log('advancedOutput', 'æ²¡æœ‰è¿è¡Œä¸­çš„ç›‘å¬å™¨', 'error');
      }
    }

    async function testClear() {
      clearLog('advancedOutput');
      
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­˜å‚¨æ•°æ®å—ï¼Ÿ')) {
        log('advancedOutput', 'æ“ä½œå·²å–æ¶ˆ');
        return;
      }
      
      try {
        await StorageUtils.clear();
        log('advancedOutput', 'âœ… å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'success');
      } catch (error) {
        log('advancedOutput', `æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
      }
    }
  </script>
</body>
</html>

