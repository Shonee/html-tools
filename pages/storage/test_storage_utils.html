<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StorageUtils åŠŸèƒ½æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            max-width: 1600px;
            margin: 0 auto;
            align-items: flex-start;
        }

        .left-content {
            flex: 1;
            min-width: 0;
        }

        .right-sidebar {
            width: 400px;
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .log-sidebar {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        h1 {
            color: #2563eb;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #64748b;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .env-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .env-extension {
            background: #dbeafe;
            color: #1e40af;
        }

        .env-html {
            background: #dcfce7;
            color: #15803d;
        }

        .section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 2px solid #e2e8f0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #2563eb;
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 6px;
        }

        input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
        }

        .log-container {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            flex: 1;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .log-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: #2563eb;
            background: #eff6ff;
            transform: none;
            box-shadow: none;
        }

        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: #94a3b8;
            margin-right: 8px;
        }

        .log-success {
            color: #34d399;
        }

        .log-error {
            color: #f87171;
        }

        .log-info {
            color: #60a5fa;
        }

        .log-warning {
            color: #fbbf24;
        }

        .result-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .hint {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
            color: #92400e;
        }

        .hint strong {
            color: #78350f;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 1200px) {
            .right-sidebar {
                width: 350px;
            }
        }

        @media (max-width: 992px) {
            .main-layout {
                flex-direction: column;
            }
            
            .right-sidebar {
                width: 100%;
                position: relative;
                top: 0;
                max-height: 500px;
                order: 2;
            }
            
            .left-content {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .right-sidebar {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <div class="left-content">
            <div class="container">
                <h1>ğŸ—„ï¸ StorageUtils åŠŸèƒ½æµ‹è¯•</h1>
                <div class="subtitle">å®Œæ•´æµ‹è¯•æµè§ˆå™¨ç¼“å­˜æ“ä½œå·¥å…·çš„æ‰€æœ‰åŠŸèƒ½</div>
                
                <div class="env-badge" id="envBadge">
                    <span id="envIcon">ğŸ”Œ</span>
                    <span id="envText">åŠ è½½ä¸­...</span>
                </div>

                <!-- Tab å¯¼èˆª -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('basic')">åŸºç¡€æ“ä½œ</button>
                    <button class="tab" onclick="switchTab('batch')">æ‰¹é‡æ“ä½œ</button>
                    <button class="tab" onclick="switchTab('query')">æŸ¥è¯¢åŠŸèƒ½</button>
                    <button class="tab" onclick="switchTab('advanced')">é«˜çº§åŠŸèƒ½</button>
                    <button class="tab" onclick="switchTab('auto')">è‡ªåŠ¨åŒ–æµ‹è¯•</button>
                </div>

                <!-- Tab å†…å®¹ - åŸºç¡€æ“ä½œ -->
                <div id="tab-basic" class="tab-content active">
                    <div class="section">
                        <div class="section-title">ğŸ“ åŸºç¡€å¢åˆ æ”¹æŸ¥</div>
                        
                        <div class="grid-2">
                            <div class="form-group">
                                <label>é”®å (Key)</label>
                                <input type="text" id="basicKey" placeholder="ä¾‹å¦‚: username" value="testKey">
                            </div>
                            <div class="form-group">
                                <label>å€¼ (Value)</label>
                                <input type="text" id="basicValue" placeholder="ä¾‹å¦‚: å¼ ä¸‰" value="Hello World">
                            </div>
                        </div>

                        <div class="button-group">
                            <button class="btn-primary" onclick="testSet()">ğŸ’¾ è®¾ç½®æ•°æ® (set)</button>
                            <button class="btn-success" onclick="testGet()">ğŸ” è·å–æ•°æ® (get)</button>
                            <button class="btn-warning" onclick="testUpdate()">âœï¸ æ›´æ–°æ•°æ® (update)</button>
                            <button class="btn-danger" onclick="testRemove()">ğŸ—‘ï¸ åˆ é™¤æ•°æ® (remove)</button>
                        </div>

                        <div class="hint">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>å…ˆç‚¹å‡»"è®¾ç½®æ•°æ®"å­˜å‚¨ä¸€æ¡æ•°æ®ï¼Œç„¶åå°è¯•"è·å–æ•°æ®"ã€"æ›´æ–°æ•°æ®"æˆ–"åˆ é™¤æ•°æ®"ã€‚
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ”„ å¯¹è±¡æ›´æ–°æµ‹è¯•</div>
                        
                        <div class="form-group">
                            <label>å¯¹è±¡é”®å</label>
                            <input type="text" id="objectKey" placeholder="ä¾‹å¦‚: userInfo" value="userProfile">
                        </div>

                        <div class="button-group">
                            <button class="btn-primary" onclick="testInitObject()">åˆå§‹åŒ–å¯¹è±¡</button>
                            <button class="btn-warning" onclick="testUpdateObject()">æ›´æ–°éƒ¨åˆ†å­—æ®µ</button>
                            <button class="btn-success" onclick="testGetObject()">æŸ¥çœ‹å¯¹è±¡</button>
                        </div>

                        <div class="hint">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>update æ–¹æ³•å¯ä»¥åˆå¹¶æ›´æ–°å¯¹è±¡ï¼Œä¿ç•™æœªä¿®æ”¹çš„å­—æ®µã€‚
                        </div>
                    </div>
                </div>

                <!-- Tab å†…å®¹ - æ‰¹é‡æ“ä½œ -->
                <div id="tab-batch" class="tab-content">
                    <div class="section">
                        <div class="section-title">ğŸ“¦ æ‰¹é‡è®¾ç½® (setBatch)</div>
                        
                        <div class="form-group">
                            <label>æ‰¹é‡æ•°æ® (JSON æ ¼å¼)</label>
                            <textarea id="batchData" placeholder='ä¾‹å¦‚: {"key1": "value1", "key2": "value2"}'>{
  "user1": {"name": "å¼ ä¸‰", "age": 25},
  "user2": {"name": "æå››", "age": 30},
  "user3": {"name": "ç‹äº”", "age": 35}
}</textarea>
                        </div>

                        <div class="button-group">
                            <button class="btn-primary" onclick="testBatchSet()">æ‰¹é‡è®¾ç½®</button>
                            <button class="btn-success" onclick="testBatchGet()">æ‰¹é‡è·å–</button>
                            <button class="btn-danger" onclick="testBatchRemove()">æ‰¹é‡åˆ é™¤</button>
                        </div>

                        <div class="hint">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>æ‰¹é‡æ“ä½œå¯ä»¥ä¸€æ¬¡å¤„ç†å¤šä¸ªé”®å€¼å¯¹ï¼Œæé«˜æ•ˆç‡ã€‚
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ”‘ æ‰¹é‡é”®å</div>
                        
                        <div class="form-group">
                            <label>é”®ååˆ—è¡¨ (é€—å·åˆ†éš”)</label>
                            <input type="text" id="batchKeys" placeholder="ä¾‹å¦‚: user1,user2,user3" value="user1,user2,user3">
                        </div>

                        <div class="button-group">
                            <button class="btn-success" onclick="testBatchGetByKeys()">æŒ‰é”®åæ‰¹é‡è·å–</button>
                            <button class="btn-danger" onclick="testBatchRemoveByKeys()">æŒ‰é”®åæ‰¹é‡åˆ é™¤</button>
                        </div>
                    </div>
                </div>

                <!-- Tab å†…å®¹ - æŸ¥è¯¢åŠŸèƒ½ -->
                <div id="tab-query" class="tab-content">
                    <div class="section">
                        <div class="section-title">ğŸ” æŸ¥è¯¢ä¸æ£€æŸ¥</div>
                        
                        <div class="button-group">
                            <button class="btn-info" onclick="testGetAllKeys()">ğŸ“‹ è·å–æ‰€æœ‰é”® (getAllKeys)</button>
                            <button class="btn-info" onclick="testHas()">âœ… æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ (has)</button>
                            <button class="btn-info" onclick="testGetBytesInUse()">ğŸ“Š è·å–å­˜å‚¨å¤§å° (getBytesInUse)</button>
                        </div>

                        <div class="form-group" style="margin-top: 16px;">
                            <label>æ£€æŸ¥çš„é”®å</label>
                            <input type="text" id="checkKey" placeholder="ä¾‹å¦‚: testKey" value="testKey">
                        </div>

                        <div class="hint">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>getBytesInUse ä»…åœ¨ Chrome æ‰©å±•ç¯å¢ƒä¸­å¯ç”¨ã€‚
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ“ˆ å­˜å‚¨ç»Ÿè®¡</div>
                        
                        <button class="btn-primary" onclick="showStorageStats()">åˆ·æ–°ç»Ÿè®¡æ•°æ®</button>
                        
                        <div class="stats-grid" id="statsGrid">
                            <div class="stat-card">
                                <div class="stat-value" id="statKeyCount">-</div>
                                <div class="stat-label">é”®æ•°é‡</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statBytes">-</div>
                                <div class="stat-label">å­˜å‚¨å¤§å°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="statEnv">-</div>
                                <div class="stat-label">è¿è¡Œç¯å¢ƒ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab å†…å®¹ - é«˜çº§åŠŸèƒ½ -->
                <div id="tab-advanced" class="tab-content">
                    <div class="section">
                        <div class="section-title">ğŸ‘‚ ç›‘å¬æ•°æ®å˜åŒ– (onChanged)</div>
                        
                        <div class="button-group">
                            <button class="btn-warning" onclick="testOnChanged()">ğŸ§ å¯åŠ¨ç›‘å¬å™¨</button>
                            <button class="btn-secondary" onclick="stopListening()">â¹ï¸ åœæ­¢ç›‘å¬</button>
                            <button class="btn-primary" onclick="triggerChange()">ğŸ”„ è§¦å‘æµ‹è¯•å˜åŒ–</button>
                        </div>

                        <div class="hint">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>å¯åŠ¨ç›‘å¬åï¼Œä»»ä½•æ•°æ®å˜åŒ–éƒ½ä¼šè¢«æ•è·å¹¶æ˜¾ç¤ºåœ¨æ—¥å¿—ä¸­ã€‚
                            <br><strong>æ³¨æ„ï¼š</strong>åœ¨æ™®é€š HTML é¡µé¢ä¸­ï¼ŒlocalStorage çš„ç›‘å¬ä»…å¯¹è·¨æ ‡ç­¾é¡µçš„å˜åŒ–æœ‰æ•ˆï¼ˆå½“å‰é¡µé¢çš„ä¿®æ”¹ä¸ä¼šè§¦å‘è‡ªèº«çš„ç›‘å¬äº‹ä»¶ï¼‰ã€‚
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ§¹ æ¸…ç©ºæ“ä½œ</div>
                        
                        <button class="btn-danger" onclick="testClear()">âš ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ® (clear)</button>

                        <div class="hint" style="background: #fee2e2; border-color: #fca5a5; color: #7f1d1d;">
                            <strong>âš ï¸ è­¦å‘Šï¼š</strong>æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰å­˜å‚¨çš„æ•°æ®ï¼Œæ— æ³•æ¢å¤ï¼
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">â„¹ï¸ ç¯å¢ƒä¿¡æ¯</div>
                        
                        <button class="btn-info" onclick="showEnvInfo()">æŸ¥çœ‹è¯¦ç»†ç¯å¢ƒä¿¡æ¯</button>
                        
                        <div class="result-box" id="envInfoBox" style="display: none;"></div>
                    </div>
                </div>

                <!-- Tab å†…å®¹ - è‡ªåŠ¨åŒ–æµ‹è¯• -->
                <div id="tab-auto" class="tab-content">
                    <div class="section">
                        <div class="section-title">ğŸ¤– ä¸€é”®å…¨é¢æµ‹è¯•</div>
                        
                        <p style="color: #64748b; margin-bottom: 16px;">
                            è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰åŠŸèƒ½æµ‹è¯•ï¼ŒéªŒè¯ StorageUtils çš„å®Œæ•´æ€§ã€‚æµ‹è¯•åŒ…æ‹¬ï¼šåŸºç¡€æ“ä½œã€æ‰¹é‡æ“ä½œã€æŸ¥è¯¢åŠŸèƒ½ã€æ›´æ–°æ“ä½œç­‰ã€‚
                        </p>

                        <div class="button-group">
                            <button class="btn-primary" onclick="runFullTest()">â–¶ï¸ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                            <button class="btn-warning" onclick="runQuickTest()">âš¡ å¿«é€Ÿæµ‹è¯•</button>
                        </div>

                        <div class="hint">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>å®Œæ•´æµ‹è¯•ä¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰åŠŸèƒ½ç‚¹ï¼Œå¹¶åœ¨å³ä¾§æ—¥å¿—ä¸­æ˜¾ç¤ºè¯¦ç»†ç»“æœã€‚
                        </div>
                    </div>

                    <div class="section">
                        <div class="section-title">ğŸ“Š æµ‹è¯•ç»“æœ</div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="testTotal">0</div>
                                <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="testPassed" style="color: #10b981;">0</div>
                                <div class="stat-label">é€šè¿‡</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="testFailed" style="color: #ef4444;">0</div>
                                <div class="stat-label">å¤±è´¥</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§æ—¥å¿—é¢æ¿ -->
        <div class="right-sidebar">
            <div class="log-sidebar">
                <div class="log-header">
                    <div class="log-title">ğŸ“ æ“ä½œæ—¥å¿—</div>
                    <button class="btn-secondary" onclick="clearLog()" style="padding: 6px 12px; font-size: 12px;">æ¸…ç©º</button>
                </div>
                <div class="log-container" id="logContainer">
                    <div class="log-info">ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="storage_utils.js"></script>
    <script>
        let unsubscribe = null;
        let testStats = { total: 0, passed: 0, failed: 0 };

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            displayEnvInfo();
            log('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
        });

        // åˆ‡æ¢ Tab
        function switchTab(tabName) {
            // æ›´æ–° Tab æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–° Tab å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            log(`åˆ‡æ¢åˆ° ${getTabName(tabName)} æ ‡ç­¾é¡µ`, 'info');
        }

        function getTabName(tabId) {
            const names = {
                'basic': 'åŸºç¡€æ“ä½œ',
                'batch': 'æ‰¹é‡æ“ä½œ',
                'query': 'æŸ¥è¯¢åŠŸèƒ½',
                'advanced': 'é«˜çº§åŠŸèƒ½',
                'auto': 'è‡ªåŠ¨åŒ–æµ‹è¯•'
            };
            return names[tabId] || tabId;
        }

        // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        function displayEnvInfo() {
            const info = StorageUtils.getEnvironmentInfo();
            const envBadge = document.getElementById('envBadge');
            const envIcon = document.getElementById('envIcon');
            const envText = document.getElementById('envText');

            if (info.isExtension) {
                envBadge.className = 'env-badge env-extension';
                envIcon.textContent = 'ğŸ”Œ';
                envText.textContent = 'Chrome æ‰©å±•ç¯å¢ƒ';
            } else {
                envBadge.className = 'env-badge env-html';
                envIcon.textContent = 'ğŸŒ';
                envText.textContent = 'æ™®é€š HTML é¡µé¢';
            }

            log(`è¿è¡Œç¯å¢ƒ: ${info.type} (${info.isExtension ? 'Chrome Extension' : 'HTML Page'})`, 'info');
        }

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const typeClass = `log-${type}`;
            entry.innerHTML = `<span class="log-time">[${timestamp}]</span><span class="${typeClass}">${message}</span>`;
            
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '<div class="log-info">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // ==================== åŸºç¡€æ“ä½œ ====================
        
        async function testSet() {
            const key = document.getElementById('basicKey').value;
            const value = document.getElementById('basicValue').value;
            
            try {
                await StorageUtils.set(key, value);
                log(`âœ… è®¾ç½®æˆåŠŸ: ${key} = "${value}"`, 'success');
            } catch (error) {
                log(`âŒ è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGet() {
            const key = document.getElementById('basicKey').value;
            
            try {
                const value = await StorageUtils.get(key);
                log(`âœ… è·å–æˆåŠŸ: ${key} = ${JSON.stringify(value)}`, 'success');
            } catch (error) {
                log(`âŒ è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testUpdate() {
            const key = document.getElementById('basicKey').value;
            
            try {
                // å…ˆè®¾ç½®ä¸€ä¸ªå¯¹è±¡
                await StorageUtils.set(key, { name: 'å¼ ä¸‰', age: 25, city: 'åŒ—äº¬' });
                log(`åˆå§‹åŒ–å¯¹è±¡: ${key}`, 'info');
                
                // æ›´æ–°éƒ¨åˆ†å­—æ®µ
                await StorageUtils.update(key, { age: 26, country: 'ä¸­å›½' });
                const updated = await StorageUtils.get(key);
                log(`âœ… æ›´æ–°æˆåŠŸ: ${JSON.stringify(updated)}`, 'success');
            } catch (error) {
                log(`âŒ æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testRemove() {
            const key = document.getElementById('basicKey').value;
            
            try {
                await StorageUtils.remove(key);
                log(`âœ… åˆ é™¤æˆåŠŸ: ${key}`, 'success');
                
                const value = await StorageUtils.get(key);
                log(`éªŒè¯åˆ é™¤: ${key} = ${value}`, 'info');
            } catch (error) {
                log(`âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testInitObject() {
            const key = document.getElementById('objectKey').value;
            const data = {
                name: 'å¼ ä¸‰',
                age: 25,
                email: 'zhangsan@example.com',
                role: 'developer'
            };
            
            try {
                await StorageUtils.set(key, data);
                log(`âœ… åˆå§‹åŒ–å¯¹è±¡: ${key}`, 'success');
                log(`æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
            } catch (error) {
                log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testUpdateObject() {
            const key = document.getElementById('objectKey').value;
            
            try {
                await StorageUtils.update(key, { 
                    age: 26, 
                    department: 'ç ”å‘éƒ¨',
                    lastUpdated: new Date().toISOString()
                });
                log(`âœ… æ›´æ–°å¯¹è±¡æˆåŠŸ`, 'success');
            } catch (error) {
                log(`âŒ æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetObject() {
            const key = document.getElementById('objectKey').value;
            
            try {
                const data = await StorageUtils.get(key);
                log(`âœ… è·å–å¯¹è±¡æˆåŠŸ:`, 'success');
                log(JSON.stringify(data, null, 2), 'info');
            } catch (error) {
                log(`âŒ è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ==================== æ‰¹é‡æ“ä½œ ====================
        
        async function testBatchSet() {
            const dataText = document.getElementById('batchData').value;
            
            try {
                const data = JSON.parse(dataText);
                await StorageUtils.setBatch(data);
                log(`âœ… æ‰¹é‡è®¾ç½®æˆåŠŸï¼Œå…± ${Object.keys(data).length} æ¡æ•°æ®`, 'success');
            } catch (error) {
                log(`âŒ æ‰¹é‡è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testBatchGet() {
            const keys = ['user1', 'user2', 'user3'];
            
            try {
                const result = await StorageUtils.getBatch(keys);
                log(`âœ… æ‰¹é‡è·å–æˆåŠŸ:`, 'success');
                log(JSON.stringify(result, null, 2), 'info');
            } catch (error) {
                log(`âŒ æ‰¹é‡è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testBatchRemove() {
            const keys = ['user1', 'user2', 'user3'];
            
            try {
                await StorageUtils.removeBatch(keys);
                log(`âœ… æ‰¹é‡åˆ é™¤æˆåŠŸ: ${keys.join(', ')}`, 'success');
            } catch (error) {
                log(`âŒ æ‰¹é‡åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testBatchGetByKeys() {
            const keysText = document.getElementById('batchKeys').value;
            const keys = keysText.split(',').map(k => k.trim()).filter(k => k);
            
            try {
                const result = await StorageUtils.getBatch(keys);
                log(`âœ… æ‰¹é‡è·å–æˆåŠŸ (${keys.length} ä¸ªé”®):`, 'success');
                log(JSON.stringify(result, null, 2), 'info');
            } catch (error) {
                log(`âŒ æ‰¹é‡è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testBatchRemoveByKeys() {
            const keysText = document.getElementById('batchKeys').value;
            const keys = keysText.split(',').map(k => k.trim()).filter(k => k);
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ ${keys.length} ä¸ªé”®å—ï¼Ÿ\n${keys.join(', ')}`)) {
                try {
                    await StorageUtils.removeBatch(keys);
                    log(`âœ… æ‰¹é‡åˆ é™¤æˆåŠŸ: ${keys.join(', ')}`, 'success');
                } catch (error) {
                    log(`âŒ æ‰¹é‡åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                }
            }
        }

        // ==================== æŸ¥è¯¢åŠŸèƒ½ ====================
        
        async function testGetAllKeys() {
            try {
                const keys = await StorageUtils.getAllKeys();
                log(`âœ… è·å–æ‰€æœ‰é”®æˆåŠŸï¼Œå…± ${keys.length} ä¸ª:`, 'success');
                log(JSON.stringify(keys, null, 2), 'info');
            } catch (error) {
                log(`âŒ è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testHas() {
            const key = document.getElementById('checkKey').value;
            
            try {
                const exists = await StorageUtils.has(key);
                if (exists) {
                    log(`âœ… é”® "${key}" å­˜åœ¨`, 'success');
                } else {
                    log(`âš ï¸ é”® "${key}" ä¸å­˜åœ¨`, 'warning');
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetBytesInUse() {
            try {
                const result = await StorageUtils.getBytesInUse();
                if (result.error) {
                    log(`âš ï¸ ${result.error}`, 'warning');
                } else {
                    const kb = (result.bytesInUse / 1024).toFixed(2);
                    log(`âœ… å­˜å‚¨ä½¿ç”¨é‡: ${result.bytesInUse} å­—èŠ‚ (çº¦ ${kb} KB)`, 'success');
                }
            } catch (error) {
                log(`âŒ è·å–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function showStorageStats() {
            try {
                const keys = await StorageUtils.getAllKeys();
                const info = StorageUtils.getEnvironmentInfo();
                
                document.getElementById('statKeyCount').textContent = keys.length;
                document.getElementById('statEnv').textContent = info.isExtension ? 'æ‰©å±•' : 'HTML';
                
                const bytesResult = await StorageUtils.getBytesInUse();
                if (bytesResult.error) {
                    document.getElementById('statBytes').textContent = 'N/A';
                } else {
                    const kb = (bytesResult.bytesInUse / 1024).toFixed(2);
                    document.getElementById('statBytes').textContent = `${kb} KB`;
                }
                
                log('âœ… ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°', 'success');
            } catch (error) {
                log(`âŒ åˆ·æ–°ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ==================== é«˜çº§åŠŸèƒ½ ====================
        
        function testOnChanged() {
            if (unsubscribe) {
                log('âš ï¸ ç›‘å¬å™¨å·²åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }

            unsubscribe = StorageUtils.onChanged((changes, areaName) => {
                log(`ğŸ§ æ£€æµ‹åˆ° ${areaName} å­˜å‚¨å˜åŒ–`, 'info');
                Object.keys(changes).forEach(key => {
                    const change = changes[key];
                    log(`  â€¢ ${key}:`, 'info');
                    log(`    æ—§å€¼: ${JSON.stringify(change.oldValue)}`, 'info');
                    log(`    æ–°å€¼: ${JSON.stringify(change.newValue)}`, 'info');
                });
            });
            
            log('âœ… ç›‘å¬å™¨å·²å¯åŠ¨', 'success');
            
            const info = StorageUtils.getEnvironmentInfo();
            if (!info.isExtension) {
                log('âš ï¸ æ³¨æ„: localStorage ç›‘å¬ä»…å¯¹è·¨æ ‡ç­¾é¡µå˜åŒ–æœ‰æ•ˆ', 'warning');
            }
        }

        function stopListening() {
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
                log('âœ… ç›‘å¬å™¨å·²åœæ­¢', 'success');
            } else {
                log('âš ï¸ æ²¡æœ‰è¿è¡Œä¸­çš„ç›‘å¬å™¨', 'warning');
            }
        }

        async function triggerChange() {
            try {
                const testKey = 'listener_test_' + Date.now();
                await StorageUtils.set(testKey, { timestamp: new Date().toISOString() });
                log(`âœ… è§¦å‘æµ‹è¯•å˜åŒ–: ${testKey}`, 'success');
                
                // åœ¨æ‰©å±•ç¯å¢ƒä¸­ï¼Œç«‹å³å°±èƒ½çœ‹åˆ°å˜åŒ–
                // åœ¨æ™®é€š HTML ä¸­ï¼Œéœ€è¦æ‰“å¼€å¦ä¸€ä¸ªæ ‡ç­¾é¡µæ‰èƒ½çœ‹åˆ°
                const info = StorageUtils.getEnvironmentInfo();
                if (!info.isExtension) {
                    log('ğŸ’¡ æç¤º: è¯·åœ¨å¦ä¸€ä¸ªæ ‡ç­¾é¡µä¸­æ‰“å¼€æ­¤é¡µé¢æŸ¥çœ‹ç›‘å¬æ•ˆæœ', 'info');
                }
            } catch (error) {
                log(`âŒ è§¦å‘å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testClear() {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­˜å‚¨æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ¢å¤ï¼')) {
                log('æ“ä½œå·²å–æ¶ˆ', 'info');
                return;
            }
            
            try {
                await StorageUtils.clear();
                log('âœ… å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®', 'success');
            } catch (error) {
                log(`âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`, 'error');
            }
        }

        function showEnvInfo() {
            const info = StorageUtils.getEnvironmentInfo();
            const box = document.getElementById('envInfoBox');
            box.style.display = 'block';
            box.textContent = JSON.stringify(info, null, 2);
            log('âœ… ç¯å¢ƒä¿¡æ¯å·²æ˜¾ç¤º', 'success');
        }

        // ==================== è‡ªåŠ¨åŒ–æµ‹è¯• ====================
        
        async function runFullTest() {
            log('==================== å¼€å§‹å®Œæ•´æµ‹è¯• ====================', 'info');
            testStats = { total: 0, passed: 0, failed: 0 };
            
            await sleep(500);
            
            // æµ‹è¯• 1: åŸºç¡€è®¾ç½®å’Œè·å–
            await runTest('åŸºç¡€è®¾ç½®å’Œè·å–', async () => {
                await StorageUtils.set('test_key_1', 'test_value_1');
                const value = await StorageUtils.get('test_key_1');
                if (value !== 'test_value_1') throw new Error('å€¼ä¸åŒ¹é…');
            });

            // æµ‹è¯• 2: å¯¹è±¡å­˜å‚¨
            await runTest('å¯¹è±¡å­˜å‚¨', async () => {
                const obj = { name: 'æµ‹è¯•', age: 30 };
                await StorageUtils.set('test_obj', obj);
                const retrieved = await StorageUtils.get('test_obj');
                if (retrieved.name !== obj.name || retrieved.age !== obj.age) {
                    throw new Error('å¯¹è±¡æ•°æ®ä¸åŒ¹é…');
                }
            });

            // æµ‹è¯• 3: æ•°ç»„å­˜å‚¨
            await runTest('æ•°ç»„å­˜å‚¨', async () => {
                const arr = [1, 2, 3, 4, 5];
                await StorageUtils.set('test_arr', arr);
                const retrieved = await StorageUtils.get('test_arr');
                if (JSON.stringify(retrieved) !== JSON.stringify(arr)) {
                    throw new Error('æ•°ç»„æ•°æ®ä¸åŒ¹é…');
                }
            });

            // æµ‹è¯• 4: æ›´æ–°æ“ä½œ
            await runTest('å¯¹è±¡æ›´æ–°', async () => {
                await StorageUtils.set('test_update', { a: 1, b: 2 });
                await StorageUtils.update('test_update', { b: 3, c: 4 });
                const result = await StorageUtils.get('test_update');
                if (result.a !== 1 || result.b !== 3 || result.c !== 4) {
                    throw new Error('æ›´æ–°åæ•°æ®ä¸æ­£ç¡®');
                }
            });

            // æµ‹è¯• 5: åˆ é™¤æ“ä½œ
            await runTest('åˆ é™¤æ“ä½œ', async () => {
                await StorageUtils.set('test_delete', 'to_be_deleted');
                await StorageUtils.remove('test_delete');
                const value = await StorageUtils.get('test_delete');
                if (value !== null) throw new Error('åˆ é™¤åä»å­˜åœ¨');
            });

            // æµ‹è¯• 6: æ‰¹é‡è®¾ç½®
            await runTest('æ‰¹é‡è®¾ç½®', async () => {
                const data = { batch1: 'v1', batch2: 'v2', batch3: 'v3' };
                await StorageUtils.setBatch(data);
                const v1 = await StorageUtils.get('batch1');
                if (v1 !== 'v1') throw new Error('æ‰¹é‡è®¾ç½®å¤±è´¥');
            });

            // æµ‹è¯• 7: æ‰¹é‡è·å–
            await runTest('æ‰¹é‡è·å–', async () => {
                const result = await StorageUtils.getBatch(['batch1', 'batch2', 'batch3']);
                if (!result.batch1 || !result.batch2 || !result.batch3) {
                    throw new Error('æ‰¹é‡è·å–å¤±è´¥');
                }
            });

            // æµ‹è¯• 8: æ‰¹é‡åˆ é™¤
            await runTest('æ‰¹é‡åˆ é™¤', async () => {
                await StorageUtils.removeBatch(['batch1', 'batch2', 'batch3']);
                const v1 = await StorageUtils.get('batch1');
                if (v1 !== null) throw new Error('æ‰¹é‡åˆ é™¤å¤±è´¥');
            });

            // æµ‹è¯• 9: è·å–æ‰€æœ‰é”®
            await runTest('è·å–æ‰€æœ‰é”®', async () => {
                await StorageUtils.set('key_a', 1);
                await StorageUtils.set('key_b', 2);
                const keys = await StorageUtils.getAllKeys();
                if (!Array.isArray(keys)) throw new Error('è¿”å›çš„ä¸æ˜¯æ•°ç»„');
            });

            // æµ‹è¯• 10: æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
            await runTest('æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨', async () => {
                await StorageUtils.set('exists_key', 'value');
                const exists = await StorageUtils.has('exists_key');
                const notExists = await StorageUtils.has('not_exists_key');
                if (!exists || notExists) throw new Error('has æ–¹æ³•ç»“æœé”™è¯¯');
            });

            updateTestStats();
            log('==================== æµ‹è¯•å®Œæˆ ====================', 'info');
            log(`æ€»è®¡: ${testStats.total}, é€šè¿‡: ${testStats.passed}, å¤±è´¥: ${testStats.failed}`, 
                testStats.failed === 0 ? 'success' : 'error');
        }

        async function runQuickTest() {
            log('==================== å¿«é€Ÿæµ‹è¯• ====================', 'info');
            testStats = { total: 0, passed: 0, failed: 0 };
            
            await runTest('åŸºç¡€å­˜å–', async () => {
                await StorageUtils.set('quick_test', 'hello');
                const value = await StorageUtils.get('quick_test');
                if (value !== 'hello') throw new Error('å€¼ä¸åŒ¹é…');
            });

            await runTest('æ‰¹é‡æ“ä½œ', async () => {
                await StorageUtils.setBatch({ q1: 1, q2: 2 });
                const result = await StorageUtils.getBatch(['q1', 'q2']);
                if (result.q1 !== 1) throw new Error('æ‰¹é‡æ“ä½œå¤±è´¥');
            });

            await runTest('æŸ¥è¯¢åŠŸèƒ½', async () => {
                const keys = await StorageUtils.getAllKeys();
                const has = await StorageUtils.has('quick_test');
                if (!Array.isArray(keys) || !has) throw new Error('æŸ¥è¯¢å¤±è´¥');
            });

            updateTestStats();
            log('==================== å¿«é€Ÿæµ‹è¯•å®Œæˆ ====================', 'info');
        }

        async function runTest(name, testFunc) {
            testStats.total++;
            try {
                await testFunc();
                testStats.passed++;
                log(`âœ… [${testStats.total}] ${name} - é€šè¿‡`, 'success');
            } catch (error) {
                testStats.failed++;
                log(`âŒ [${testStats.total}] ${name} - å¤±è´¥: ${error.message}`, 'error');
            }
            await sleep(100);
        }

        function updateTestStats() {
            document.getElementById('testTotal').textContent = testStats.total;
            document.getElementById('testPassed').textContent = testStats.passed;
            document.getElementById('testFailed').textContent = testStats.failed;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>

