"/**\n * GitHub API 操作模块\n * 提供与 GitHub 仓库交互的增删改查功能\n */\n\nclass GitHubAPI {\n  constructor() {\n    this.baseURL = \"https://api.github.com\";\n    this.config = null;\n  }\n\n  /**\n   * 初始化配置\n   * @param {Object} config - 配置对象\n   * @param {string} config.accessToken - GitHub Personal Access Token\n   * @param {string} config.owner - 仓库所有者（可选）\n   * @param {string} config.repo - 仓库名称（可选）\n   * @param {string} config.branch - 分支名称（可选，默认: main）\n   * @param {string} config.filePath - 文件路径（可选，默认: prompts_data.json）\n   */\n  async init(config) {\n    this.config = {\n      accessToken: config.accessToken,\n      owner: config.owner || \"\",\n      repo: config.repo || \"\",\n      branch: config.branch || \"main\",\n      filePath: config.filePath || \"prompts_data.json\",\n    };\n    \n    // 保存配置到 storage\n    // await chrome.storage.local.set({ githubConfig: this.config });\n    // 保存配置\n    if (typeof chrome !== 'undefined' && chrome.storage) {\n        await chrome.storage.local.set({ githubConfig: this.config });\n    }\n  }\n\n  /**\n   * 从 storage 加载配置\n   */\n  async loadConfig() {\n    return new Promise((resolve) => {\n      chrome.storage.local.get([\"githubConfig\"], (result) => {\n        if (result.githubConfig) {\n          this.config = result.githubConfig;\n          resolve(true);\n        } else {\n          resolve(false);\n        }\n      });\n    });\n  }\n\n  /**\n   * 获取请求头\n   */\n  getHeaders() {\n    return {\n      Authorization: `token ${this.config.accessToken}`,\n      Accept: \"application/vnd.github.v3+json\",\n      \"Content-Type\": \"application/json\",\n    };\n  }\n\n  /**\n   * 从 GitHub 获取文件内容\n   * @param {string} filePath - 文件路径（可选，使用配置中的filePath）\n   * @param {string} owner - 仓库所有者（可选）\n   * @param {string} repo - 仓库名称（可选）\n   * @param {string} branch - 分支名称（可选）\n   * @returns {Promise<Object>} 返回文件内容、SHA 和类型信息\n   */\n  async getFile(filePath = null, owner = null, repo = null, branch = null) {\n    try {\n      const _owner = owner || this.config.owner;\n      const _repo = repo || this.config.repo;\n      const _branch = branch || this.config.branch;\n      const _filePath = filePath || this.config.filePath;\n      \n      if (!_owner || !_repo) {\n        throw new Error(\"请指定仓库所有者和仓库名称\");\n      }\n      \n      if (!_filePath) {\n        throw new Error(\"请指定文件路径\");\n      }\n\n      const url = `${this.baseURL}/repos/${_owner}/${_repo}/contents/${_filePath}?ref=${_branch}`;\n      \n      const response = await fetch(url, {\n        method: \"GET\",\n        headers: this.getHeaders(),\n      });\n\n      if (!response.ok) {\n        if (response.status === 404) {\n          return { content: null, sha: null, isJson: false };\n        }\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      // 先解码 base64 内容\n      const decodedContent = decodeURIComponent(escape(atob(data.content)));\n      \n      // 尝试解析为 JSON，如果失败则返回原始文本\n      let content;\n      let isJson = false;\n      try {\n        content = JSON.parse(decodedContent);\n        isJson = true;\n      } catch (e) {\n        // 不是 JSON 格式，返回原始文本\n        content = decodedContent;\n        isJson = false;\n      }\n      \n      return {\n        content: content,\n        sha: data.sha,\n        isJson: isJson,\n        rawContent: decodedContent\n      };\n    } catch (error) {\n      console.error(\"获取 GitHub 文件失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 创建或更新 GitHub 文件\n   * @param {Object} content - 文件内容\n   * @param {string} sha - 文件的 SHA (更新时必需)\n   * @param {string} message - 提交信息\n   * @param {string} filePath - 文件路径（可选）\n   * @param {string} owner - 仓库所有者（可选）\n   * @param {string} repo - 仓库名称（可选）\n   * @param {string} branch - 分支名称（可选）\n   * @returns {Promise<Object>} 返回更新后的文件信息\n   */\n  async updateFile(content, sha = null, message = \"Update file\", filePath = null, owner = null, repo = null, branch = null) {\n    try {\n      const _owner = owner || this.config.owner;\n      const _repo = repo || this.config.repo;\n      const _branch = branch || this.config.branch;\n      const _filePath = filePath || this.config.filePath;\n      \n      if (!_owner || !_repo) {\n        throw new Error(\"请指定仓库所有者和仓库名称\");\n      }\n      \n      if (!_filePath) {\n        throw new Error(\"请指定文件路径\");\n      }\n\n      const url = `${this.baseURL}/repos/${_owner}/${_repo}/contents/${_filePath}`;\n      \n      const body = {\n        message: message,\n        content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),\n        branch: _branch,\n      };\n\n      if (sha) {\n        body.sha = sha;\n      }\n\n      const response = await fetch(url, {\n        method: \"PUT\",\n        headers: this.getHeaders(),\n        body: JSON.stringify(body),\n      });\n\n      if (!response.ok) {\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      return {\n        success: true,\n        sha: data.content.sha,\n        url: data.content.html_url,\n      };\n    } catch (error) {\n      console.error(\"更新 GitHub 文件失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 删除 GitHub 文件\n   * @param {string} sha - 文件的 SHA\n   * @param {string} message - 提交信息\n   * @param {string} filePath - 文件路径（可选）\n   * @param {string} owner - 仓库所有者（可选）\n   * @param {string} repo - 仓库名称（可选）\n   * @param {string} branch - 分支名称（可选）\n   * @returns {Promise<Object>}\n   */\n  async deleteFile(sha, message = \"Delete file\", filePath = null, owner = null, repo = null, branch = null) {\n    try {\n      const _owner = owner || this.config.owner;\n      const _repo = repo || this.config.repo;\n      const _branch = branch || this.config.branch;\n      const _filePath = filePath || this.config.filePath;\n      \n      if (!_owner || !_repo) {\n        throw new Error(\"请指定仓库所有者和仓库名称\");\n      }\n      \n      if (!_filePath) {\n        throw new Error(\"请指定文件路径\");\n      }\n\n      const url = `${this.baseURL}/repos/${_owner}/${_repo}/contents/${_filePath}`;\n      \n      const response = await fetch(url, {\n        method: \"DELETE\",\n        headers: this.getHeaders(),\n        body: JSON.stringify({\n          message: message,\n          sha: sha,\n          branch: _branch,\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      return { success: true };\n    } catch (error) {\n      console.error(\"删除 GitHub 文件失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 同步本地数据到 GitHub\n   * @param {Array} prompts - 提示词数组\n   * @returns {Promise<Object>}\n   */\n  async syncToGitHub(prompts) {\n    try {\n      // 获取当前文件的 SHA\n      const { sha } = await this.getFile();\n      \n      const data = {\n        prompts: prompts,\n        version: \"1.0.0\",\n        lastSync: new Date().toISOString(),\n      };\n\n      const result = await this.updateFile(\n        data,\n        sha,\n        `Sync prompts data at ${new Date().toLocaleString()}`\n      );\n\n      return result;\n    } catch (error) {\n      console.error(\"同步到 GitHub 失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 从 GitHub 拉取数据到本地\n   * @returns {Promise<Array>} 返回提示词数组\n   */\n  async pullFromGitHub() {\n    try {\n      const { content } = await this.getFile();\n      \n      if (!content || !content.prompts) {\n        throw new Error(\"GitHub 文件格式不正确\");\n      }\n\n      // 保存到本地 storage\n      await chrome.storage.local.set({\n        myPrompts: content.prompts,\n        lastGitHubSync: new Date().toISOString(),\n      });\n\n      return content.prompts;\n    } catch (error) {\n      console.error(\"从 GitHub 拉取失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 测试 GitHub 连接\n   * @returns {Promise<boolean>}\n   */\n  async testConnection() {\n    try {\n      const url = `${this.baseURL}/user`;\n      \n      const response = await fetch(url, {\n        method: \"GET\",\n        headers: this.getHeaders(),\n      });\n\n      return response.ok;\n    } catch (error) {\n      console.error(\"测试 GitHub 连接失败:\", error);\n      return false;\n    }\n  }\n\n  /**\n   * 获取当前用户信息\n   * @returns {Promise<Object>} 返回用户信息\n   */\n  async getUserInfo() {\n    try {\n      const url = `${this.baseURL}/user`;\n      \n      const response = await fetch(url, {\n        method: \"GET\",\n        headers: this.getHeaders(),\n      });\n\n      if (!response.ok) {\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      return await response.json();\n    } catch (error) {\n      console.error(\"获取用户信息失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 获取用户可访问的仓库列表\n   * @param {number} per_page - 每页数量（默认30，最大100）\n   * @param {number} page - 页码（默认1）\n   * @returns {Promise<Array>} 返回仓库列表\n   */\n  async listRepositories(per_page = 30, page = 1) {\n    try {\n      const url = `${this.baseURL}/user/repos?per_page=${per_page}&page=${page}&sort=updated`;\n      \n      const response = await fetch(url, {\n        method: \"GET\",\n        headers: this.getHeaders(),\n      });\n\n      if (!response.ok) {\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      const repos = await response.json();\n      return repos.map(repo => ({\n        name: repo.name,\n        full_name: repo.full_name,\n        owner: repo.owner.login,\n        private: repo.private,\n        description: repo.description,\n        updated_at: repo.updated_at,\n        default_branch: repo.default_branch\n      }));\n    } catch (error) {\n      console.error(\"获取仓库列表失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 获取指定仓库的分支列表\n   * @param {string} owner - 仓库所有者（可选，使用配置中的owner）\n   * @param {string} repo - 仓库名称（可选，使用配置中的repo）\n   * @returns {Promise<Array>} 返回分支列表\n   */\n  async listBranches(owner = null, repo = null) {\n    try {\n      const _owner = owner || this.config.owner;\n      const _repo = repo || this.config.repo;\n      \n      if (!_owner || !_repo) {\n        throw new Error(\"请指定仓库所有者和仓库名称\");\n      }\n\n      const url = `${this.baseURL}/repos/${_owner}/${_repo}/branches`;\n      \n      const response = await fetch(url, {\n        method: \"GET\",\n        headers: this.getHeaders(),\n      });\n\n      if (!response.ok) {\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      const branches = await response.json();\n      return branches.map(branch => ({\n        name: branch.name,\n        protected: branch.protected,\n        commit_sha: branch.commit.sha\n      }));\n    } catch (error) {\n      console.error(\"获取分支列表失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 获取指定仓库的文件列表（指定路径下的内容）\n   * @param {string} path - 路径（默认为根目录\"\"）\n   * @param {string} owner - 仓库所有者（可选）\n   * @param {string} repo - 仓库名称（可选）\n   * @param {string} branch - 分支名称（可选）\n   * @returns {Promise<Array>} 返回文件/目录列表\n   */\n  async listFiles(path = \"\", owner = null, repo = null, branch = null) {\n    try {\n      const _owner = owner || this.config.owner;\n      const _repo = repo || this.config.repo;\n      const _branch = branch || this.config.branch;\n      \n      if (!_owner || !_repo) {\n        throw new Error(\"请指定仓库所有者和仓库名称\");\n      }\n\n      const url = `${this.baseURL}/repos/${_owner}/${_repo}/contents/${path}?ref=${_branch}`;\n      \n      const response = await fetch(url, {\n        method: \"GET\",\n        headers: this.getHeaders(),\n      });\n\n      if (!response.ok) {\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      const contents = await response.json();\n      \n      // 如果返回的是单个文件而不是数组，则包装成数组\n      const items = Array.isArray(contents) ? contents : [contents];\n      \n      return items.map(item => ({\n        name: item.name,\n        path: item.path,\n        type: item.type, // \"file\" or \"dir\"\n        size: item.size,\n        sha: item.sha,\n        download_url: item.download_url\n      }));\n    } catch (error) {\n      console.error(\"获取文件列表失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 从 GitHub URL 下载文件\n   * @param {string} url - GitHub 文件的完整 URL\n   * @param {boolean} useToken - 是否使用 Access Token 进行认证（私有仓库需要）\n   * @returns {Promise<Object>} 返回文件内容、元信息和是否为 JSON\n   */\n  async downloadFileFromUrl(url, useToken = false) {\n    try {\n      // 支持多种 GitHub URL 格式\n      // 1. https://github.com/owner/repo/blob/branch/path/to/file\n      // 2. https://raw.githubusercontent.com/owner/repo/branch/path/to/file\n      // 3. https://api.github.com/repos/owner/repo/contents/path/to/file\n      \n      let apiUrl = url;\n      let fileName = \"downloaded_file\";\n      \n      // 处理 github.com/blob URL\n      if (url.includes('github.com') && url.includes('/blob/')) {\n        const match = url.match(/github\\.com\\/([^\\/]+)\\/([^\\/]+)\\/blob\\/([^\\/]+)\\/(.+)/);\n        if (match) {\n          const [, owner, repo, branch, filePath] = match;\n          apiUrl = `${this.baseURL}/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`;\n          fileName = filePath.split('/').pop();\n        }\n      }\n      // 处理 raw.githubusercontent.com URL\n      else if (url.includes('raw.githubusercontent.com')) {\n        const match = url.match(/raw\\.githubusercontent\\.com\\/([^\\/]+)\\/([^\\/]+)\\/([^\\/]+)\\/(.+)/);\n        if (match) {\n          const [, owner, repo, branch, filePath] = match;\n          apiUrl = `${this.baseURL}/repos/${owner}/${repo}/contents/${filePath}?ref=${branch}`;\n          fileName = filePath.split('/').pop();\n        }\n      }\n      // API URL 直接使用\n      else if (url.includes('api.github.com/repos')) {\n        const match = url.match(/repos\\/[^\\/]+\\/[^\\/]+\\/contents\\/(.+?)(?:\\?|$)/);\n        if (match) {\n          fileName = match[1].split('/').pop();\n        }\n      }\n\n      // 构建请求头\n      const headers = {};\n      if (useToken && this.config && this.config.accessToken) {\n        headers.Authorization = `token ${this.config.accessToken}`;\n        headers.Accept = \"application/vnd.github.v3+json\";\n      }\n\n      const response = await fetch(apiUrl, {\n        method: \"GET\",\n        headers: headers,\n      });\n\n      if (!response.ok) {\n        if (response.status === 404) {\n          throw new Error(\"文件不存在或无访问权限，私有仓库请启用 Token 认证\");\n        }\n        throw new Error(`GitHub API Error: ${response.status} ${response.statusText}`);\n      }\n\n      const data = await response.json();\n      \n      // 解码 base64 内容\n      const decodedContent = decodeURIComponent(escape(atob(data.content)));\n      \n      // 尝试解析为 JSON\n      let content;\n      let isJson = false;\n      try {\n        content = JSON.parse(decodedContent);\n        isJson = true;\n      } catch (e) {\n        content = decodedContent;\n        isJson = false;\n      }\n      \n      return {\n        content: content,\n        rawContent: decodedContent,\n        fileName: data.name || fileName,\n        size: data.size,\n        sha: data.sha,\n        isJson: isJson,\n        downloadUrl: data.download_url,\n        htmlUrl: data.html_url\n      };\n    } catch (error) {\n      console.error(\"下载 GitHub 文件失败:\", error);\n      throw error;\n    }\n  }\n\n  /**\n   * 将文件内容保存到本地\n   * @param {string} content - 文件内容\n   * @param {string} fileName - 文件名\n   * @param {boolean} isJson - 是否为 JSON 格式\n   */\n  saveFileToLocal(content, fileName, isJson = false) {\n    try {\n      // 创建 Blob 对象\n      const blob = new Blob(\n        [isJson ? JSON.stringify(content, null, 2) : content],\n        { type: isJson ? 'application/json' : 'text/plain' }\n      );\n      \n      // 创建下载链接\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = fileName;\n      \n      // 触发下载\n      document.body.appendChild(a);\n      a.click();\n      \n      // 清理\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n      \n      return true;\n    } catch (error) {\n      console.error(\"保存文件到本地失败:\", error);\n      throw error;\n    }\n  }\n}\n\n// 导出单例\nconst githubAPI = new GitHubAPI();"